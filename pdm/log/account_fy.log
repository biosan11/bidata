
20190308125837å¼€å§‹æ‰§è¡Œ2019-03-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308125837
create temporary table edw.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190308125838
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308125838

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then '²©Ê¥' 
            when a.db = 'UFDATA_118_2018' then '×¿¶÷'
            when a.db = 'UFDATA_123_2018' then '¶÷ÔÊ'
            when a.db = 'UFDATA_168_2018' then 'º¼Öİ±´Éú'
            when a.db = 'UFDATA_169_2018' then 'ÔÆ¶¦'
            when a.db = 'UFDATA_222_2018' then '±¦ÈÙ'
            when a.db = 'UFDATA_333_2018' then 'Äş²¨±´Éú'
            when a.db = 'UFDATA_588_2018' then '°Â²©ÌØ'
            when a.db = 'UFDATA_666_2018' then 'Æô´ú'
            when a.db = 'UFDATA_889_2018' then 'ÃÀ²©ÌØ'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.subcompanyname
      ,b.u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      ,case when b.liuchengbh is null then 'U8¶ÀÓĞ' else '¹²ÓĞ' end as state
  from edw.accvouch_u8_pre a
	left join (select * from edw.accvouch_oa group by liuchengbh,jine) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine
 where a.md > 0
;

20190308130232å¼€å§‹æ‰§è¡Œ2019-03-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308130232
create temporary table edw.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190308130233
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308130233

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then '²©Ê¥' 
            when a.db = 'UFDATA_118_2018' then '×¿¶÷'
            when a.db = 'UFDATA_123_2018' then '¶÷ÔÊ'
            when a.db = 'UFDATA_168_2018' then 'º¼Öİ±´Éú'
            when a.db = 'UFDATA_169_2018' then 'ÔÆ¶¦'
            when a.db = 'UFDATA_222_2018' then '±¦ÈÙ'
            when a.db = 'UFDATA_333_2018' then 'Äş²¨±´Éú'
            when a.db = 'UFDATA_588_2018' then '°Â²©ÌØ'
            when a.db = 'UFDATA_666_2018' then 'Æô´ú'
            when a.db = 'UFDATA_889_2018' then 'ÃÀ²©ÌØ'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.subcompanyname
      ,b.u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      ,case when b.liuchengbh is null then 'U8¶ÀÓĞ' else '¹²ÓĞ' end as state
  from edw.accvouch_u8_pre a
	left join (select * from edw.accvouch_oa group by liuchengbh,jine) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine
 where a.md > 0
;

20190308130438å¼€å§‹æ‰§è¡Œ2019-03-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308130438
create temporary table edw.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190308130438
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308130438

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then '²©Ê¥' 
            when a.db = 'UFDATA_118_2018' then '×¿¶÷'
            when a.db = 'UFDATA_123_2018' then '¶÷ÔÊ'
            when a.db = 'UFDATA_168_2018' then 'º¼Öİ±´Éú'
            when a.db = 'UFDATA_169_2018' then 'ÔÆ¶¦'
            when a.db = 'UFDATA_222_2018' then '±¦ÈÙ'
            when a.db = 'UFDATA_333_2018' then 'Äş²¨±´Éú'
            when a.db = 'UFDATA_588_2018' then '°Â²©ÌØ'
            when a.db = 'UFDATA_666_2018' then 'Æô´ú'
            when a.db = 'UFDATA_889_2018' then 'ÃÀ²©ÌØ'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.subcompanyname
      ,b.u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      ,case when b.liuchengbh is null then 'U8¶ÀÓĞ' else '¹²ÓĞ' end as state
  from edw.accvouch_u8_pre a
	left join (select * from edw.accvouch_oa group by liuchengbh,jine) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine
 where a.md > 0
;

20190308130633å¼€å§‹æ‰§è¡Œ2019-03-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308130633
create temporary table edw.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190308130634
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308130634

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then '²©Ê¥' 
            when a.db = 'UFDATA_118_2018' then '×¿¶÷'
            when a.db = 'UFDATA_123_2018' then '¶÷ÔÊ'
            when a.db = 'UFDATA_168_2018' then 'º¼Öİ±´Éú'
            when a.db = 'UFDATA_169_2018' then 'ÔÆ¶¦'
            when a.db = 'UFDATA_222_2018' then '±¦ÈÙ'
            when a.db = 'UFDATA_333_2018' then 'Äş²¨±´Éú'
            when a.db = 'UFDATA_588_2018' then '°Â²©ÌØ'
            when a.db = 'UFDATA_666_2018' then 'Æô´ú'
            when a.db = 'UFDATA_889_2018' then 'ÃÀ²©ÌØ'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.subcompanyname
      ,b.u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      ,case when b.liuchengbh is null then 'U8¶ÀÓĞ' else '¹²ÓĞ' end as state
  from edw.accvouch_u8_pre a
	left join (select * from edw.accvouch_oa group by liuchengbh,jine) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine
 where a.md > 0
;

20190308130733å¼€å§‹æ‰§è¡Œ2019-03-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308130733
create temporary table edw.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190308130734
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308130734

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then '²©Ê¥' 
            when a.db = 'UFDATA_118_2018' then '×¿¶÷'
            when a.db = 'UFDATA_123_2018' then '¶÷ÔÊ'
            when a.db = 'UFDATA_168_2018' then 'º¼Öİ±´Éú'
            when a.db = 'UFDATA_169_2018' then 'ÔÆ¶¦'
            when a.db = 'UFDATA_222_2018' then '±¦ÈÙ'
            when a.db = 'UFDATA_333_2018' then 'Äş²¨±´Éú'
            when a.db = 'UFDATA_588_2018' then '°Â²©ÌØ'
            when a.db = 'UFDATA_666_2018' then 'Æô´ú'
            when a.db = 'UFDATA_889_2018' then 'ÃÀ²©ÌØ'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.subcompanyname
      ,b.u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      ,case when b.liuchengbh is null then 'U8¶ÀÓĞ' else '¹²ÓĞ' end as state
  from edw.accvouch_u8_pre a
	left join (select * from edw.accvouch_oa group by liuchengbh,jine) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine
 where a.md > 0
;

20190308130903å¼€å§‹æ‰§è¡Œ2019-03-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308130903
create temporary table edw.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190308130904
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308130904

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then '²©Ê¥' 
            when a.db = 'UFDATA_118_2018' then '×¿¶÷'
            when a.db = 'UFDATA_123_2018' then '¶÷ÔÊ'
            when a.db = 'UFDATA_168_2018' then 'º¼Öİ±´Éú'
            when a.db = 'UFDATA_169_2018' then 'ÔÆ¶¦'
            when a.db = 'UFDATA_222_2018' then '±¦ÈÙ'
            when a.db = 'UFDATA_333_2018' then 'Äş²¨±´Éú'
            when a.db = 'UFDATA_588_2018' then '°Â²©ÌØ'
            when a.db = 'UFDATA_666_2018' then 'Æô´ú'
            when a.db = 'UFDATA_889_2018' then 'ÃÀ²©ÌØ'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.subcompanyname
      ,b.u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      ,case when b.liuchengbh is null then 'U8¶ÀÓĞ' else '¹²ÓĞ' end as state
  from edw.accvouch_u8_pre a
	left join (select * from edw.accvouch_oa group by liuchengbh,jine) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine
 where a.md > 0
;

20190308130948å¼€å§‹æ‰§è¡Œ2019-03-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308130948
create temporary table edw.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190308130949
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308130949

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then '²©Ê¥' 
            when a.db = 'UFDATA_118_2018' then '×¿¶÷'
            when a.db = 'UFDATA_123_2018' then '¶÷ÔÊ'
            when a.db = 'UFDATA_168_2018' then 'º¼Öİ±´Éú'
            when a.db = 'UFDATA_169_2018' then 'ÔÆ¶¦'
            when a.db = 'UFDATA_222_2018' then '±¦ÈÙ'
            when a.db = 'UFDATA_333_2018' then 'Äş²¨±´Éú'
            when a.db = 'UFDATA_588_2018' then '°Â²©ÌØ'
            when a.db = 'UFDATA_666_2018' then 'Æô´ú'
            when a.db = 'UFDATA_889_2018' then 'ÃÀ²©ÌØ'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.subcompanyname
      ,b.u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      ,case when b.liuchengbh is null then 'U8¶ÀÓĞ' else '¹²ÓĞ' end as state
  from edw.accvouch_u8_pre a
	left join (select * from edw.accvouch_oa group by liuchengbh,jine) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine
 where a.md > 0
;

20190308131133å¼€å§‹æ‰§è¡Œ2019-03-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308131133
create temporary table edw.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190308131134
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308131134

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then '²©Ê¥' 
            when a.db = 'UFDATA_118_2018' then '×¿¶÷'
            when a.db = 'UFDATA_123_2018' then '¶÷ÔÊ'
            when a.db = 'UFDATA_168_2018' then 'º¼Öİ±´Éú'
            when a.db = 'UFDATA_169_2018' then 'ÔÆ¶¦'
            when a.db = 'UFDATA_222_2018' then '±¦ÈÙ'
            when a.db = 'UFDATA_333_2018' then 'Äş²¨±´Éú'
            when a.db = 'UFDATA_588_2018' then '°Â²©ÌØ'
            when a.db = 'UFDATA_666_2018' then 'Æô´ú'
            when a.db = 'UFDATA_889_2018' then 'ÃÀ²©ÌØ'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.subcompanyname
      ,b.u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      ,case when b.liuchengbh is null then 'U8¶ÀÓĞ' else '¹²ÓĞ' end as state
  from edw.accvouch_u8_pre a
	left join (select * from edw.accvouch_oa group by liuchengbh,jine) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine
 where a.md > 0
;

20190308131224å¼€å§‹æ‰§è¡Œ2019-03-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308131224
create temporary table edw.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190308131224
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308131224

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then '²©Ê¥' 
            when a.db = 'UFDATA_118_2018' then '×¿¶÷'
            when a.db = 'UFDATA_123_2018' then '¶÷ÔÊ'
            when a.db = 'UFDATA_168_2018' then 'º¼Öİ±´Éú'
            when a.db = 'UFDATA_169_2018' then 'ÔÆ¶¦'
            when a.db = 'UFDATA_222_2018' then '±¦ÈÙ'
            when a.db = 'UFDATA_333_2018' then 'Äş²¨±´Éú'
            when a.db = 'UFDATA_588_2018' then '°Â²©ÌØ'
            when a.db = 'UFDATA_666_2018' then 'Æô´ú'
            when a.db = 'UFDATA_889_2018' then 'ÃÀ²©ÌØ'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.subcompanyname
      ,b.u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      ,case when b.liuchengbh is null then 'U8¶ÀÓĞ' else '¹²ÓĞ' end as state
  from edw.accvouch_u8_pre a
	left join (select * from edw.accvouch_oa group by liuchengbh,jine) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine
 where a.md > 0
;

20190308131352å¼€å§‹æ‰§è¡Œ2019-03-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308131352
create temporary table edw.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190308131353
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308131353

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then '²©Ê¥' 
            when a.db = 'UFDATA_118_2018' then '×¿¶÷'
            when a.db = 'UFDATA_123_2018' then '¶÷ÔÊ'
            when a.db = 'UFDATA_168_2018' then 'º¼Öİ±´Éú'
            when a.db = 'UFDATA_169_2018' then 'ÔÆ¶¦'
            when a.db = 'UFDATA_222_2018' then '±¦ÈÙ'
            when a.db = 'UFDATA_333_2018' then 'Äş²¨±´Éú'
            when a.db = 'UFDATA_588_2018' then '°Â²©ÌØ'
            when a.db = 'UFDATA_666_2018' then 'Æô´ú'
            when a.db = 'UFDATA_889_2018' then 'ÃÀ²©ÌØ'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.subcompanyname
      ,b.u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      ,case when b.liuchengbh is null then 'U8¶ÀÓĞ' else '¹²ÓĞ' end as state
  from edw.accvouch_u8_pre a
	left join (select * from edw.accvouch_oa group by liuchengbh,jine) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine
 where a.md > 0
;

20190308133918å¼€å§‹æ‰§è¡Œ2019-03-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308133918
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190308133919
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308133919

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190308133920
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308133920


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8kemubm
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190308133921
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308133921

create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode,ccode_name) b
    on a.u8kemubm = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190308133922
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308133922

truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190308133922
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190308133922
insert into pdm.account_fy
select a.i_id
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190308133922

20190315001520å¼€å§‹æ‰§è¡Œ2019-03-14æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190315001520
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190315001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190315001521

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190315001522
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190315001522


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190315001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190315001523


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190315001524
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190315001524

truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190315001524
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190315001524
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190315001526
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190315001526

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190315001526
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190315001526
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190315001526
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190315001526
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190315001526

20190316001513å¼€å§‹æ‰§è¡Œ2019-03-15æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190316001513
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190316001513
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190316001513

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190316001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190316001514


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190316001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190316001516


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190316001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190316001517

truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190316001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190316001517
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190316001518
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190316001518

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190316001518
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190316001518
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190316001518
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190316001518
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190316001518

20190317001511å¼€å§‹æ‰§è¡Œ2019-03-16æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190317001511
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190317001512
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190317001512

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190317001513
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190317001513


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190317001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190317001514


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190317001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190317001515

truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190317001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190317001515
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190317001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190317001517

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190317001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190317001517
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190317001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190317001517
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190317001517

20190318001513å¼€å§‹æ‰§è¡Œ2019-03-17æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190318001513
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190318001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190318001514

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190318001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190318001515


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190318001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190318001516


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190318001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190318001517

truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190318001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190318001517
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190318001519
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190318001519

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190318001519
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190318001519
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190318001519
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190318001519
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190318001519

20190319001513å¼€å§‹æ‰§è¡Œ2019-03-18æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190319001513
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190319001513
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190319001514

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190319001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190319001515


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190319001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190319001516


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190319001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190319001517

truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190319001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190319001517
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190319001519
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190319001519

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190319001519
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190319001519
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190319001519
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190319001519
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190319001519

20190320001510å¼€å§‹æ‰§è¡Œ2019-03-19æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190320001510
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-03-19'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190320001510
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190320001510

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190320001511
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190320001511


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190320001512
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190320001512


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190320001512
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190320001512

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190320001520
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190320001520
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190320001520
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190320001520

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190320001520
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190320001520
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190320001520
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190320001520
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190320001520

20190321001512å¼€å§‹æ‰§è¡Œ2019-03-20æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190321001512
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-03-20'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190321001513
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190321001513

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190321001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190321001514


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190321001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190321001514


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190321001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190321001515

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190321001520
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190321001520
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190321001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190321001521

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190321001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190321001521
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190321001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190321001521
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190321001521

20190322112634å¼€å§‹æ‰§è¡Œ2019-03-21æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190322112634
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-03-21'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190322112634
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190322112634

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190322112635
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190322112635


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190322112636
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190322112636


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190322112637
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190322112637

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190322112640
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190322112640
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190322112641
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190322112641

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190322112641
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190322112641
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190322112641
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190322112641
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190322112641

20190323001513å¼€å§‹æ‰§è¡Œ2019-03-22æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190323001513
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-03-22'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190323001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190323001514

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190323001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190323001515


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190323001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190323001516


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190323001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190323001516

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190323001520
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190323001520
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190323001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190323001521

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190323001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190323001521
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190323001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190323001521
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190323001521

20190324001519å¼€å§‹æ‰§è¡Œ2019-03-23æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190324001519
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-03-23'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190324001519
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190324001519

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190324001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190324001521


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190324001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190324001521


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190324001522
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190324001522

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190324001522
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190324001522
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190324001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190324001523

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190324001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190324001523
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190324001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190324001523
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190324001523

20190325001513å¼€å§‹æ‰§è¡Œ2019-03-24æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190325001513
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-03-24'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190325001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190325001514

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190325001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190325001515


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190325001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190325001515


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190325001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190325001515

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190325001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190325001515
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190325001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190325001515

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190325001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190325001515
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190325001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190325001515
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190325001515

20190326001511å¼€å§‹æ‰§è¡Œ2019-03-25æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190326001511
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-03-25'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190326001512
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190326001512

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190326001513
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190326001513


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190326001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190326001514


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190326001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190326001514

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190326001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190326001523
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190326001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190326001523

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190326001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190326001523
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190326001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190326001523
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190326001523

20190327001514å¼€å§‹æ‰§è¡Œ2019-03-26æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190327001514
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-03-26'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190327001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190327001515

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190327001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190327001516


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190327001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190327001517


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190327001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190327001517

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190327001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190327001523
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190327001524
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190327001524

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190327001524
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190327001524
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190327001524
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190327001524
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190327001524

20190328001511å¼€å§‹æ‰§è¡Œ2019-03-27æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190328001511
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-03-27'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190328001511
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190328001511

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190328001513
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190328001513


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190328001513
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190328001513


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190328001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190328001514

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190328001518
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190328001518
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190328001519
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190328001519

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190328001519
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190328001519
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190328001519
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190328001519
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190328001519

20190329001510å¼€å§‹æ‰§è¡Œ2019-03-28æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190329001510
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-03-28'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190329001511
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190329001511

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190329001512
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190329001512


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190329001512
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190329001512


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190329001513
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190329001513

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190329001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190329001515
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190329001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190329001516

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190329001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190329001516
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190329001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190329001516
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190329001516

20190330001512å¼€å§‹æ‰§è¡Œ2019-03-29æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190330001512
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-03-29'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190330001512
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190330001512

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190330001513
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190330001513


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190330001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190330001514


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190330001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190330001515

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190330001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190330001515
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190330001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190330001516

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190330001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190330001516
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190330001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190330001516
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190330001516

20190331001512å¼€å§‹æ‰§è¡Œ2019-03-30æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190331001512
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-03-30'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190331001512
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190331001512

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190331001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190331001514


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190331001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190331001514


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190331001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190331001514

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190331001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190331001514
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190331001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190331001514

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190331001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190331001514
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190331001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190331001514
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190331001514

20190401001515å¼€å§‹æ‰§è¡Œ2019-03-31æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401001515
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-03-31'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401001516

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401001517


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401001517


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401001517

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401001517
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401001517

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401001517
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190401001517
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190401001517

20190402001514å¼€å§‹æ‰§è¡Œ2019-04-01æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190402001514
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190402001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190402001514

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190402001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190402001515


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190402001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190402001516


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190402001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190402001517

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190402001522
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190402001522
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190402001522
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190402001522

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190402001522
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190402001522
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190402001522
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190402001522
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190402001522

20190403001519å¼€å§‹æ‰§è¡Œ2019-04-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190403001519
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-02'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190403001519
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190403001519

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190403001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190403001521


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190403001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190403001521


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190403001522
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190403001522

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190403001527
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190403001527
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190403001528
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190403001528

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190403001528
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190403001528
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190403001528
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190403001528
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190403001528

20190404135118å¼€å§‹æ‰§è¡Œ2019-04-03æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190404135118
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-03'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190404135118
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190404135118

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190404135119
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190404135119


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190404135120
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190404135120


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190404135121
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190404135121

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190404135125
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190404135125
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190404135126
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190404135126

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190404135126
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190404135126
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190404135126
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190404135126
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190404135126

20190405001518å¼€å§‹æ‰§è¡Œ2019-04-04æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190405001518
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-04'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190405001518
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190405001518

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190405001520
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190405001520


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190405001520
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190405001520


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190405001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190405001521

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190405001526
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190405001526
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190405001526
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190405001526

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190405001526
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190405001526
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190405001526
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190405001526
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190405001526

20190406001515å¼€å§‹æ‰§è¡Œ2019-04-05æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190406001515
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-05'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190406001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190406001516

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190406001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190406001517


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190406001518
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190406001518


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190406001518
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190406001518

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190406001519
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190406001519
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190406001520
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190406001520

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190406001520
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190406001520
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190406001520
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190406001520
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190406001520

20190407001524å¼€å§‹æ‰§è¡Œ2019-04-06æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190407001524
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-06'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190407001524
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190407001524

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190407001525
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190407001525


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190407001525
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190407001525


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190407001525
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190407001525

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190407001525
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190407001525
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190407001525
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190407001525

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190407001525
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190407001525
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190407001525
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190407001525
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190407001525

20190408001516å¼€å§‹æ‰§è¡Œ2019-04-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408001516
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-07'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408001516

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408001517


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408001517


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408001518
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408001518

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408001518
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408001518
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408001518
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408001518

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408001518
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408001518
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408001518
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408001518
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408001518

20190408114221å¼€å§‹æ‰§è¡Œ2019-03-01æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408114221
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-03-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408114222
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408114222

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408114223
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408114223


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408114225
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408114225


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408114225
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408114225

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408114412
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408114412
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408114414
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408114414

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408114414
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408114414
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408114414
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190408114414
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190408114414

20190409001517å¼€å§‹æ‰§è¡Œ2019-04-08æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190409001517
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-08'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190409001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190409001517

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190409001519
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190409001519


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190409001520
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190409001520


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190409001520
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190409001520

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190409001526
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190409001526
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190409001527
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190409001527

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190409001527
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190409001527
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190409001527
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190409001527
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190409001527

20190410001516å¼€å§‹æ‰§è¡Œ2019-04-09æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190410001516
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-09'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190410001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190410001516

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190410001518
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190410001518


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190410001518
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190410001518


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190410001519
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190410001519

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190410001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190410001523
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190410001524
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190410001524

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190410001524
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190410001524
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190410001524
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190410001524
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190410001524

20190411001522å¼€å§‹æ‰§è¡Œ2019-04-10æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190411001522
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-10'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190411001522
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190411001522

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190411001524
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190411001524


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190411001525
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190411001525


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190411001525
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190411001525

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190411001528
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190411001528
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190411001529
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190411001529

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190411001529
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190411001529
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190411001529
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190411001529
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190411001529

20190412001523å¼€å§‹æ‰§è¡Œ2019-04-11æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190412001523
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-11'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190412001524
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190412001524

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190412001525
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190412001525


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190412001526
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190412001526


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190412001527
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190412001527

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190412001531
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190412001531
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190412001532
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190412001532

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190412001532
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190412001532
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190412001532
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190412001532
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190412001532

20190413001520å¼€å§‹æ‰§è¡Œ2019-04-12æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190413001520
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-12'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190413001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190413001521

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190413001522
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190413001522


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190413001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190413001523


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190413001524
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190413001524

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190413001524
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190413001524
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190413001525
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190413001525

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190413001525
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190413001525
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190413001525
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190413001525
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190413001525

20190414001529å¼€å§‹æ‰§è¡Œ2019-04-13æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190414001529
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-13'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190414001529
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190414001529

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190414001531
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190414001531


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190414001531
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190414001531


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190414001531
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190414001531

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190414001531
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190414001531
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190414001531
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190414001531

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190414001531
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190414001531
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190414001531
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190414001531
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190414001531

20190415001514å¼€å§‹æ‰§è¡Œ2019-04-14æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190415001514
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-14'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190415001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190415001514

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190415001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190415001516


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190415001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190415001516


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190415001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190415001516

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190415001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190415001516
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190415001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190415001516

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190415001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190415001516
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190415001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190415001516
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190415001516

20190416001514å¼€å§‹æ‰§è¡Œ2019-04-15æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190416001514
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-15'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190416001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190416001514

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190416001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190416001516


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190416001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190416001517


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190416001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190416001517

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190416001522
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190416001522
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190416001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190416001523

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190416001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190416001523
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190416001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190416001523
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190416001523

20190417001517å¼€å§‹æ‰§è¡Œ2019-04-16æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190417001517
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-16'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190417001518
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190417001518

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190417001519
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190417001519


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190417001520
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190417001520


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190417001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190417001521

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190417001525
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190417001525
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190417001526
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190417001526

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190417001526
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190417001526
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190417001526
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190417001526
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190417001526

20190418001514å¼€å§‹æ‰§è¡Œ2019-04-17æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190418001514
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-17'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190418001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190418001515

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190418001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190418001516


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190418001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190418001517


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190418001518
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190418001518

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190418001520
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190418001520
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190418001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190418001521

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190418001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190418001521
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190418001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190418001521
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190418001521

20190419001512å¼€å§‹æ‰§è¡Œ2019-04-18æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190419001512
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-18'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190419001512
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190419001512

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190419001514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190419001514


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190419001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190419001515


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190419001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190419001515

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190419001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190419001517
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190419001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190419001517

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190419001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190419001517
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190419001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190419001517
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190419001517

20190420001521å¼€å§‹æ‰§è¡Œ2019-04-19æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190420001521
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-19'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190420001522
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190420001522

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190420001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190420001523


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190420001524
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190420001524


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190420001525
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190420001525

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190420001526
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190420001526
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190420001527
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190420001527

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190420001527
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190420001527
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190420001527
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190420001527
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190420001527

20190421001520å¼€å§‹æ‰§è¡Œ2019-04-20æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190421001520
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-20'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190421001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190421001521

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190421001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190421001523


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190421001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190421001523


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190421001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190421001523

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190421001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190421001523
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190421001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190421001523

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190421001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190421001523
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190421001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190421001523
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190421001523

20190422001515å¼€å§‹æ‰§è¡Œ2019-04-21æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190422001515
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-21'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190422001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190422001516

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190422001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190422001517


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190422001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190422001517


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190422001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190422001517

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190422001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190422001517
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190422001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190422001517

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190422001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190422001517
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190422001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190422001517
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190422001517

20190423001519å¼€å§‹æ‰§è¡Œ2019-04-22æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190423001519
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-22'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190423001519
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190423001519

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190423001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190423001521


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190423001522
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190423001522


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190423001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190423001523

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190423001531
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190423001531
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190423001532
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190423001532

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190423001532
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190423001532
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190423001532
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190423001532
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190423001532

20190424001514å¼€å§‹æ‰§è¡Œ2019-04-23æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190424001514
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-23'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190424001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190424001515

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190424001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190424001516


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190424001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190424001517


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190424001518
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190424001518

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190424001540
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190424001540
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190424001541
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190424001541

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190424001541
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190424001541
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190424001541
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190424001541
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190424001541

20190425001513å¼€å§‹æ‰§è¡Œ2019-04-24æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190425001513
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-24'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190425001513
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190425001513

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190425001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190425001515


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190425001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190425001516


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190425001516
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190425001516

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190425001525
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190425001525
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190425001526
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190425001526

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190425001526
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190425001526
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190425001526
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190425001526
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190425001526

20190426001518å¼€å§‹æ‰§è¡Œ2019-04-25æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190426001518
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-25'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190426001519
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190426001519

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190426001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190426001521


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190426001522
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190426001522


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190426001522
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190426001522

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190426001529
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190426001529
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190426001530
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190426001530

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190426001530
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190426001530
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190426001530
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190426001530
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190426001530

20190427001524å¼€å§‹æ‰§è¡Œ2019-04-26æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190427001524
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-26'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190427001525
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190427001525

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190427001526
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190427001526


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190427001527
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190427001527


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190427001528
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190427001528

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190427001529
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190427001529
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190427001531
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190427001531

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190427001531
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190427001531
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190427001531
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190427001531
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190427001531

20190429091420å¼€å§‹æ‰§è¡Œ2019-04-28æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190429091420
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-28'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190429091421
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190429091421

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190429091422
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190429091422


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190429091423
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190429091423


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190429091424
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190429091424

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190429091429
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190429091429
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190429091430
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190429091430

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190429091430
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190429091430
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190429091430
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190429091430
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190429091430

20190430001521å¼€å§‹æ‰§è¡Œ2019-04-29æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190430001521
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-29'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190430001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190430001521

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190430001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190430001523


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190430001524
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190430001524


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190430001525
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190430001525

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190430001538
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190430001538
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190430001539
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190430001539

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190430001539
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190430001539
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190430001539
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190430001539
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190430001539

20190501001524å¼€å§‹æ‰§è¡Œ2019-04-30æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190501001524
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-04-30'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190501001524
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190501001524

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190501001526
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190501001526


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190501001527
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190501001527


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190501001528
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190501001528

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190501001541
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190501001541
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190501001542
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190501001542

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190501001542
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190501001542
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190501001542
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190501001542
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190501001542

20190502001528å¼€å§‹æ‰§è¡Œ2019-05-01æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190502001528
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-05-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190502001528
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190502001528

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190502001530
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190502001530


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190502001531
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190502001531


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190502001531
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190502001531

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190502001543
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190502001543
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190502001544
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190502001544

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190502001544
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190502001544
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190502001544
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190502001544
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190502001544

20190503001519å¼€å§‹æ‰§è¡Œ2019-05-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190503001519
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-05-02'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190503001519
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190503001519

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190503001521
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190503001521


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190503001522
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190503001522


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190503001522
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190503001522

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190503001528
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190503001528
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190503001529
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190503001529

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190503001529
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190503001529
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190503001529
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190503001529
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190503001529

20190504001523å¼€å§‹æ‰§è¡Œ2019-05-03æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190504001523
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-05-03'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190504001523
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190504001523

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190504001525
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190504001525


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190504001526
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190504001526


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190504001527
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190504001527

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190504001530
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190504001530
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190504001531
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190504001531

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190504001531
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190504001531
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190504001531
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190504001531
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190504001531

20190505001515å¼€å§‹æ‰§è¡Œ2019-05-04æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190505001515
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-05-04'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190505001515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190505001515

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190505001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190505001517


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190505001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190505001517


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190505001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190505001517

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190505001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190505001517
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190505001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190505001517

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190505001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190505001517
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190505001517
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190505001517
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190505001517

20190506001728å¼€å§‹æ‰§è¡Œ2019-05-05æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190506001728
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-05-05'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190506001728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190506001728

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190506001730
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190506001730


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190506001731
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190506001731


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190506001732
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190506001732

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190506001738
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190506001738
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190506001739
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190506001739

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190506001739
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190506001739
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190506001739
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190506001739
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190506001739

20190507001737å¼€å§‹æ‰§è¡Œ2019-05-06æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190507001737
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-05-06'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190507001738
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190507001738

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190507001740
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190507001740


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190507001741
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190507001741


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190507001742
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190507001742

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190507001750
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190507001750
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190507001752
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190507001752

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190507001752
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190507001752
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190507001752
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190507001752
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190507001752

20190508001738å¼€å§‹æ‰§è¡Œ2019-05-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190508001738
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-05-07'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190508001738
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190508001738

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190508001740
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190508001740


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190508001741
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190508001741


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190508001742
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190508001742

delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190508001750
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190508001750
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190508001751
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190508001751

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190508001751
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190508001751
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190508001751
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190508001751
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190508001751

20190509174647å¼€å§‹æ‰§è¡Œ2019-05-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190509174647
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190509174648
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190509174648

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190509174650
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190509174650


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190509174652
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190509174652


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190509174653
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190509174653

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190509174653
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190509174653




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190509175147
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190509175147
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190509175149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190509175149

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190509175149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190509175149
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190509175149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190509175149
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190509175149

20190510001813å¼€å§‹æ‰§è¡Œ2019-05-09æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190510001813
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190510001814
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190510001814

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190510001816
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190510001816


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190510001818
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190510001818


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190510001819
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190510001819

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190510001819
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190510001819




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190510002329
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190510002329
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190510002331
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190510002331

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190510002331
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190510002331
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190510002331
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190510002331
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190510002331

20190511001816å¼€å§‹æ‰§è¡Œ2019-05-10æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190511001816
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190511001817
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190511001817

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190511001819
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190511001819


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190511001821
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190511001821


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190511001822
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190511001822

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190511001822
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190511001822




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190511002332
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190511002332
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190511002334
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190511002334

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190511002334
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190511002334
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190511002334
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190511002334
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190511002334

20190512001814å¼€å§‹æ‰§è¡Œ2019-05-11æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190512001814
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190512001815
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190512001815

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190512001816
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190512001816


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190512001818
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190512001818


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190512001820
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190512001820

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190512001820
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190512001820




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190512002332
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190512002332
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190512002334
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190512002334

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190512002334
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190512002334
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190512002334
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190512002334
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190512002334

20190513001813å¼€å§‹æ‰§è¡Œ2019-05-12æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190513001813
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190513001814
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190513001814

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190513001816
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190513001816


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190513001818
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190513001818


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190513001819
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190513001819

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190513001820
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190513001820




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190513002333
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190513002333
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190513002336
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190513002336

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190513002336
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190513002336
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190513002336
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190513002336
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190513002336

20190514001826å¼€å§‹æ‰§è¡Œ2019-05-13æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190514001826
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190514001827
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190514001827

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190514001829
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190514001829


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190514001831
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190514001831


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190514001832
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190514001832

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190514001833
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190514001833




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190514002347
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190514002347
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190514002349
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190514002349

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190514002349
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190514002349
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190514002349
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190514002349
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190514002349

20190515001834å¼€å§‹æ‰§è¡Œ2019-05-14æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190515001834
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190515001834
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190515001834

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190515001836
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190515001836


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190515001838
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190515001838


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190515001840
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190515001840

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190515001840
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190515001840




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190515002401
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190515002401
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190515002403
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190515002403

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190515002403
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190515002403
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190515002403
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190515002403
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190515002403

20190516001838å¼€å§‹æ‰§è¡Œ2019-05-15æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190516001838
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190516001839
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190516001839

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190516001840
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190516001840


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190516001843
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190516001843


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190516001844
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190516001844

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190516001844
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190516001844




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190516002417
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190516002417
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190516002419
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190516002419

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190516002419
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190516002419
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190516002419
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190516002419
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190516002419

20190517001846å¼€å§‹æ‰§è¡Œ2019-05-16æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190517001846
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190517001847
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190517001847

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190517001849
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190517001849


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190517001851
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190517001851


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190517001852
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190517001852

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190517001853
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190517001853




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190517002431
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190517002431
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190517002433
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190517002433

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190517002433
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190517002433
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190517002433
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190517002433
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190517002433

20190518001840å¼€å§‹æ‰§è¡Œ2019-05-17æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190518001840
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190518001841
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190518001841

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190518001843
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190518001843


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190518001845
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190518001845


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190518001847
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190518001847

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190518001847
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190518001847




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190518002429
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190518002429
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190518002431
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190518002431

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190518002431
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190518002431
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190518002431
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190518002431
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190518002431

20190519001844å¼€å§‹æ‰§è¡Œ2019-05-18æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190519001844
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190519001845
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190519001845

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190519001847
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190519001847


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190519001849
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190519001849


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190519001851
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190519001851

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190519001851
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190519001851




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190519002435
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190519002435
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190519002438
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190519002438

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190519002438
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190519002438
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190519002438
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190519002438
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190519002438

20190520001848å¼€å§‹æ‰§è¡Œ2019-05-19æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190520001848
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190520001848
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190520001848

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190520001850
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190520001850


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190520001853
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190520001853


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190520001854
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190520001854

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190520001854
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190520001854




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190520002439
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190520002439
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190520002442
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190520002442

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190520002442
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190520002442
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190520002442
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190520002442
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190520002442

20190521001858å¼€å§‹æ‰§è¡Œ2019-05-20æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190521001858
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190521001859
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190521001859

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190521001901
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190521001901


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190521001903
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190521001903


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190521001905
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190521001905

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190521001905
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190521001905




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190521002452
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190521002452
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190521002455
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190521002455

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190521002455
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190521002455
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190521002455
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190521002455
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190521002455

20190522001858å¼€å§‹æ‰§è¡Œ2019-05-21æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190522001858
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190522001859
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190522001859

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190522001901
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190522001901


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190522001903
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190522001903


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190522001904
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190522001904

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190522001905
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190522001905




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190522002456
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190522002456
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190522002459
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190522002459

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190522002459
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190522002459
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190522002459
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190522002459
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190522002459

20190523001856å¼€å§‹æ‰§è¡Œ2019-05-22æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190523001856
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190523001856
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190523001856

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190523001858
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190523001858


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190523001901
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190523001901


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190523001902
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190523001902

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190523001902
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190523001902




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190523002500
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190523002500
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190523002503
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190523002503

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190523002503
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190523002503
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190523002503
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190523002503
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190523002503

20190524001851å¼€å§‹æ‰§è¡Œ2019-05-23æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190524001851
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190524001852
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190524001852

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190524001854
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190524001854


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190524001856
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190524001856


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190524001857
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190524001857

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190524001858
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190524001858




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190524002502
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190524002502
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190524002505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190524002505

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190524002505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190524002505
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190524002505
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190524002505
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190524002505

20190525001856å¼€å§‹æ‰§è¡Œ2019-05-24æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190525001856
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190525001857
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190525001857

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190525001859
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190525001859


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190525001901
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190525001901


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190525001903
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190525001903

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190525001903
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190525001903




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190525002519
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190525002519
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190525002522
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190525002522

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190525002522
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190525002522
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190525002522
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190525002522
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190525002522

20190526001855å¼€å§‹æ‰§è¡Œ2019-05-25æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190526001855
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190526001856
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190526001856

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190526001858
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190526001858


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190526001900
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190526001900


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190526001901
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190526001901

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190526001902
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190526001902




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190526002524
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190526002524
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190526002527
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190526002527

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190526002527
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190526002527
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190526002527
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190526002527
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190526002527

20190527001903å¼€å§‹æ‰§è¡Œ2019-05-26æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190527001903
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190527001904
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190527001904

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190527001906
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190527001906


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190527001908
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190527001908


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190527001909
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190527001909

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190527001910
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190527001910




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190527002534
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190527002534
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190527002537
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190527002537

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190527002537
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190527002537
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190527002537
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190527002537
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190527002537

20190528001906å¼€å§‹æ‰§è¡Œ2019-05-27æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190528001906
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190528001907
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190528001907

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190528001909
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190528001909


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190528001912
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190528001912


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190528001913
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190528001913

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190528001913
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190528001913




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190528002537
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190528002537
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190528002540
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190528002540

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190528002540
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190528002540
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190528002540
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190528002540
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190528002540

20190529001954å¼€å§‹æ‰§è¡Œ2019-05-28æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190529001954
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190529001955
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190529001955

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190529001957
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190529001957


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190529002000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190529002000


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190529002001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190529002001

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190529002001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190529002001




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190529002651
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190529002651
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190529002654
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190529002654

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190529002654
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190529002654
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190529002654
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190529002654
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190529002654

20190530001919å¼€å§‹æ‰§è¡Œ2019-05-29æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190530001919
create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190530001920
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190530001920

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190530001922
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190530001922


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190530001924
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190530001924


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from ufdata.code group by db,ccode) b
    on a.u8_ccode = b.ccode
   and a.db = b.db

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190530001926
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190530001926

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190530001926
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190530001926




delete from pdm.account_fy where concat(cohr,i_id) in (select concat(cohr,i_id) from pdm.account_fy_pre3)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190530002610
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190530002610
insert into pdm.account_fy
select a.i_id                 
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.name_ehr
      ,c.name_lv2
      ,c.name_lv3
      ,c.name_lv4
      ,c.name_lv5
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from ufdata.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.ehr_deptment group by name_u8) c
    on a.cdepname = c.name_u8
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190530002612
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190530002612

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190530002612
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190530002612
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190530002612
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190530002612
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190530002612

20190530172146å¼€å§‹æ‰§è¡Œoa_budget_19.pyæ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190530172146
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190530172146
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190530172146

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190530172146
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190530172146


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190530172146
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190530172146

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190530172149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190530172149


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;

20190531095230å¼€å§‹æ‰§è¡Œ2019-05-30æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190531095230
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190531095230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190531095230

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190531095230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190531095230


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190531095231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190531095231

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190531095233
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190531095233


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190531095236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190531095236


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.u8_ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190531095236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190531095236

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190531095237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190531095237




truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190531095237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190531095237
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190531095239
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190531095239

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190531095239
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190531095239
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190531095239
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190531095239
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190531095239

20190601001922å¼€å§‹æ‰§è¡Œ2019-05-31æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190601001922
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190601001922
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190601001922

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190601001922
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190601001922


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190601001923
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190601001923

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190601001925
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190601001925


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190601001928
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190601001928


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.u8_ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190601001928
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190601001928

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190601001929
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190601001929




truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190601001929
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190601001929
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190601001932
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190601001932

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190601001932
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190601001932
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190601001932
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190601001932
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190601001932

20190602001931å¼€å§‹æ‰§è¡Œ2019-06-01æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190602001931
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190602001931
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190602001931

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190602001931
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190602001931


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190602001932
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190602001932

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190602001934
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190602001934


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190602001937
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190602001937


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.u8_ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190602001937
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190602001937

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190602001938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190602001938




truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190602001938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190602001938
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190602001940
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190602001940

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190602001940
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190602001940
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190602001940
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190602001940
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190602001940

20190603001931å¼€å§‹æ‰§è¡Œ2019-06-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190603001931
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190603001931
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190603001931

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190603001931
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190603001931


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190603001932
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190603001932

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190603001934
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190603001934


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190603001936
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190603001936


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.u8_ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190603001937
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190603001937

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190603001937
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190603001937




truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190603001937
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190603001937
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190603001940
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190603001940

update pdm.account_fy set oa_kemu = '6602å†…éƒ¨ä¼šè®®è´¹',oa_code = '660204',oa_code_name = 'å†…éƒ¨ä¼šè®®è´¹',oa_code_lv2 = '660204',oa_code_name_lv2 = 'å†…éƒ¨ä¼šè®®è´¹' where i_id = '342201'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190603001940
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190603001940
update pdm.account_fy set oa_kemu = '6601å†…éƒ¨ä¼šè®®è´¹',oa_code = '66011701',oa_code_name = 'ä¸šåŠ¡æ‹›å¾…',oa_code_lv2 = '660117',oa_code_name_lv2 = 'ä¸šåŠ¡æ‹›å¾…' where i_id = '347308'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190603001940
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190603001940
update pdm.account_fy set oa_kemu = '6601è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code = '660131',oa_code_name = 'è¯•å‰‚æ‹›æ ‡ç»è´¹',oa_code_lv2 = '660131',oa_code_name_lv2 = 'è¯•å‰‚æ‹›æ ‡ç»è´¹' where i_id = '341838'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190603001940

20190604001937å¼€å§‹æ‰§è¡Œ2019-06-03æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604001937
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604001937
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604001937

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604001937
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604001937


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604001938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604001938

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604001940
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604001940


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604001943
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604001943


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.u8_ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604001943
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604001943

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604001944
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604001944




truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604001944
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604001944
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,d.oadykm
      ,d.oa_ccode
      ,d.oa_ccode_name
      ,d.oa_ccode_lv2
      ,d.oa_ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
 left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) d
	  on a.u8_liuchengbh = d.liuchengbh
	 and a.md = d.jine1

;

20190604083814å¼€å§‹æ‰§è¡Œ2019-06-03æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604083814
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604083815
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604083815

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604083815
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604083815


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604083815
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604083815

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604083818
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604083818


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604083820
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604083820


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.u8_ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604083821
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604083821

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604083821
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604083821




truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604083821
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190604083821
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190604083822

20190605001939å¼€å§‹æ‰§è¡Œ2019-06-04æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190605001939
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190605001939
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190605001939

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190605001939
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190605001939


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190605001940
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190605001940

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190605001942
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190605001942


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190605001945
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190605001945


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.u8_ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190605001945
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190605001945

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190605001946
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190605001946




truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190605001946
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190605001946
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190605001947

20190606001954å¼€å§‹æ‰§è¡Œ2019-06-05æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190606001954
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190606001954
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190606001954

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190606001954
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190606001954


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190606001955
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190606001955

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190606001957
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190606001957


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190606001959
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190606001959


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.u8_ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190606002000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190606002000

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190606002000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190606002000




truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190606002000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190606002000
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190606002002

20190607001933å¼€å§‹æ‰§è¡Œ2019-06-06æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190607001933
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190607001933
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190607001933

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190607001933
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190607001933


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190607001934
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190607001934

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190607001937
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190607001937


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190607001939
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190607001939


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.u8_ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190607001940
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190607001940

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190607001940
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190607001940




truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190607001940
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190607001940
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190607001941

20190608001943å¼€å§‹æ‰§è¡Œ2019-06-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190608001943
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190608001943
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190608001943

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190608001943
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190608001943


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190608001944
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190608001944

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190608001946
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190608001946


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190608001949
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190608001949


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.u8_ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190608001950
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190608001950

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190608001950
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190608001950




truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190608001950
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190608001950
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190608001951

20190610085018å¼€å§‹æ‰§è¡Œ2019-06-09æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190610085018
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190610085018
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190610085018

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190610085018
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190610085018


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190610085019
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190610085019

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190610085021
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190610085021


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190610085024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190610085024


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.u8_ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190610085025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190610085025

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190610085026
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190610085026




truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190610085026
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190610085026
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190610085027

20190611001951å¼€å§‹æ‰§è¡Œ2019-06-10æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190611001951
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190611001951
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190611001951

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190611001951
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190611001951


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190611001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190611001952

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190611001955
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190611001955


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190611001957
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190611001957


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.u8_ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190611001958
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190611001958

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190611001958
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190611001958




truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190611001958
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190611001958
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190611002000

20190612001955å¼€å§‹æ‰§è¡Œ2019-06-11æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190612001955
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190612001955
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190612001955

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190612001955
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190612001955


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190612001956
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190612001956

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190612001958
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190612001958


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.u8dykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.u8dykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.u8dykm end as u8dykm
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190612002001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190612002001


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is null then a.ccode else b.ccode end as ccode
      ,case when a.oa_liuchengbh is null then a.ccode_name else b.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.u8_ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190612002002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190612002002

update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190612002002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190612002002




truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190612002002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190612002002
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190612002003

20190613001952å¼€å§‹æ‰§è¡Œ2019-06-12æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190613001952
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190613001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190613001952

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190613001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190613001952


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190613001953
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190613001953

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190613001955
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190613001955


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.oadykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.oadykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.oadykm end as u8dykm
      ,b.oa_ccode
      ,b.oa_ccode_name
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190613001958
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190613001958


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is not null and a.oa_ccode is not null then a.oa_ccode
            when a.oa_liuchengbh is not null and a.oa_ccode is null then a.u8_ccode
            else a.ccode end as ccode
      ,case when a.oa_liuchengbh is not null and a.oa_ccode is not null then a.oa_ccode_name
            when a.oa_liuchengbh is not null and a.oa_ccode is null then b.ccode_name
            else a.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.u8_ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190613001959
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190613001959



update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190613001959
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190613001959




truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190613001959
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190613001959
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190613002000

20190614002024å¼€å§‹æ‰§è¡Œ2019-06-13æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190614002024
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190614002025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190614002025

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190614002025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190614002025


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190614002026
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190614002026

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190614002028
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190614002028


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.oadykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.oadykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.oadykm end as u8dykm
      ,b.oa_ccode
      ,b.oa_ccode_name
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190614002031
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190614002031


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is not null and a.oa_ccode is not null then a.oa_ccode
            when a.oa_liuchengbh is not null and a.oa_ccode is null then a.u8_ccode
            else a.ccode end as ccode
      ,case when a.oa_liuchengbh is not null and a.oa_ccode is not null then a.oa_ccode_name
            when a.oa_liuchengbh is not null and a.oa_ccode is null then b.ccode_name
            else a.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.u8_ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190614002032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190614002032



update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190614002032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190614002032




truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190614002032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190614002032
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190614002033

20190615002034å¼€å§‹æ‰§è¡Œ2019-06-14æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190615002034
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190615002034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190615002034

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190615002034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190615002034


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190615002035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190615002035

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190615002038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190615002038


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.oadykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.oadykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.oadykm end as u8dykm
      ,b.oa_ccode
      ,b.oa_ccode_name
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190615002041
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190615002041


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is not null and a.oa_ccode is not null then a.oa_ccode
            when a.oa_liuchengbh is not null and a.oa_ccode is null then a.u8_ccode
            else a.ccode end as ccode
      ,case when a.oa_liuchengbh is not null and a.oa_ccode is not null then a.oa_ccode_name
            when a.oa_liuchengbh is not null and a.oa_ccode is null then b.ccode_name
            else a.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.u8_ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190615002042
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190615002042



update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190615002042
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190615002042




truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190615002042
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190615002042
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190615002043

20190616002033å¼€å§‹æ‰§è¡Œ2019-06-15æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190616002033
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190616002033
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190616002033

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190616002033
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190616002033


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190616002034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190616002034

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190616002037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190616002037


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.oadykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.oadykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.oadykm end as u8dykm
      ,b.oa_ccode
      ,b.oa_ccode_name
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190616002040
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190616002040


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is not null and a.oa_ccode is not null then a.oa_ccode
            when a.oa_liuchengbh is not null and a.oa_ccode is null then a.u8_ccode
            else a.ccode end as ccode
      ,case when a.oa_liuchengbh is not null and a.oa_ccode is not null then a.oa_ccode_name
            when a.oa_liuchengbh is not null and a.oa_ccode is null then b.ccode_name
            else a.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.u8_ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190616002040
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190616002040



update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190616002041
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190616002041




truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190616002041
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190616002041
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190616002042

20190617002042å¼€å§‹æ‰§è¡Œ2019-06-16æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190617002042
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190617002042
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190617002042

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190617002042
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190617002042


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190617002043
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190617002043

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190617002045
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190617002045


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.oadykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.oadykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.oadykm end as u8dykm
      ,b.oa_ccode
      ,b.oa_ccode_name
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190617002049
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190617002049


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is not null and a.oa_ccode is not null then a.oa_ccode
            when a.oa_liuchengbh is not null and a.oa_ccode is null then a.u8_ccode
            else a.ccode end as ccode
      ,case when a.oa_liuchengbh is not null and a.oa_ccode is not null then a.oa_ccode_name
            when a.oa_liuchengbh is not null and a.oa_ccode is null then b.ccode_name
            else a.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.u8_ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190617002049
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190617002049



update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190617002050
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190617002050




truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190617002050
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190617002050
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190617002051

20190618002040å¼€å§‹æ‰§è¡Œ2019-06-17æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190618002040
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190618002040
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190618002040

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190618002040
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190618002040


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190618002041
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190618002041

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190618002043
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190618002043


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.oadykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.oadykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.oadykm end as u8dykm
      ,b.oa_ccode
      ,b.oa_ccode_name
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190618002046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190618002046


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is not null and a.oa_ccode is not null then a.oa_ccode
            when a.oa_liuchengbh is not null and a.oa_ccode is null then a.u8_ccode
            else a.ccode end as ccode
      ,case when a.oa_liuchengbh is not null and a.oa_ccode is not null then a.oa_ccode_name
            when a.oa_liuchengbh is not null and a.oa_ccode is null then b.ccode_name
            else a.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.u8_ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190618002047
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190618002047



update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190618002047
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190618002047




truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190618002047
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190618002047
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190618002048

20190619002047å¼€å§‹æ‰§è¡Œ2019-06-18æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190619002047
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190619002047
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190619002047

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190619002047
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190619002047


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190619002048
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190619002048

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190619002051
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190619002051


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.oadykm = '6601æ±½è½¦ä¿®ç†è´¹' then '6601æ±½è½¦ç§Ÿèµè´¹' 
            when b.oadykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.oadykm end as u8dykm
      ,b.oa_ccode
      ,b.oa_ccode_name
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190619002054
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190619002054


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is not null and a.oa_ccode is not null then a.oa_ccode
            when a.oa_liuchengbh is not null and a.oa_ccode is null then a.u8_ccode
            else a.ccode end as ccode
      ,case when a.oa_liuchengbh is not null and a.oa_ccode is not null then a.oa_ccode_name
            when a.oa_liuchengbh is not null and a.oa_ccode is null then b.ccode_name
            else a.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.u8_ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190619002054
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190619002054



update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190619002055
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190619002055




truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190619002055
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190619002055
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190619002056

20190620002045å¼€å§‹æ‰§è¡Œ2019-06-19æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190620002045
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190620002046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190620002046

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190620002046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190620002046


create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190620002047
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190620002047

create temporary table pdm.accvouch_oa_pre
select * 
      ,sum(jine) as jine1
  from edw.accvouch_oa
 group by u8dykm,kehumc,liuchengbh
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190620002049
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190620002049


create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,b.fashengrq
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,case when b.liuchengbh is null then a.bi_cusname else b.kehumc end as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,b.bx_name
      ,b.bxr_dept_name
      ,b.cd_name
      ,b.chengdanrbm
      ,b.subcompanyname
      ,b.u8_ccode
      ,case when b.oadykm = '6601ä¼šåŠ¡æ‹›å¾…è´¹' then '6601ä¼šåŠ¡æ‹›å¾…'
            else b.oadykm end as u8dykm
      ,b.oa_ccode
      ,b.oa_ccode_name
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,b.liuchengbh as oa_liuchengbh
      ,case when b.liuchengbh is null then a.sales_region else b.province end as province
      ,b.beizhu
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh,jine1) b
	  on a.liuchengbh = b.liuchengbh
	 and a.md = b.jine1
 where a.md <> 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190620002052
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190620002052


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,case when a.oa_liuchengbh is null then a.sub_name else a.u8dykm end as u8dykm
      ,case when a.oa_liuchengbh is not null and a.oa_ccode is not null then a.oa_ccode
            when a.oa_liuchengbh is not null and a.oa_ccode is null then a.u8_ccode
            else a.ccode end as ccode
      ,case when a.oa_liuchengbh is not null and a.oa_ccode is not null then a.oa_ccode_name
            when a.oa_liuchengbh is not null and a.oa_ccode is null then b.ccode_name
            else a.ccode_name end as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,a.beizhu
      ,case when a.oa_liuchengbh is null then 'u8ç‹¬æœ‰' else 'å…±æœ‰' end as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.u8_ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190620002053
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190620002053



update pdm.account_fy_pre3 a
 inner join edw.accvouch_oa b
    on a.u8_liuchengbh = b.liuchengbh
   set a.kehumc = b.kehumc
      ,a.state = 'å…±æœ‰'
 where a.state = 'u8ç‹¬æœ‰'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190620002053
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190620002053




truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190620002053
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190620002053
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.beizhu
      ,a.state
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190620002055

20190621002059å¼€å§‹æ‰§è¡Œ2019-06-20æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190621002059
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190621002059
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190621002059

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190621002059
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190621002059

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190621002100
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190621002100


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190621002101
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190621002101

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190621002103
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190621002103


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190621002104
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190621002104







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190621002104
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190621002104
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190621002104
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190621002104

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190621002105
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190621002105
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190621002106
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190621002106
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190621002106
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190621002106
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190621002107
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190621002107

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,''
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190621002111

20190622002049å¼€å§‹æ‰§è¡Œ2019-06-21æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190622002049
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190622002049
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190622002049

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190622002049
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190622002049

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190622002050
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190622002050


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190622002052
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190622002052

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190622002054
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190622002054


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190622002054
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190622002054







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190622002054
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190622002054
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190622002055
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190622002055

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190622002055
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190622002055
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190622002056
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190622002056
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190622002057
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190622002057
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190622002058
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190622002058

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,''
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190622002101

20190623002052å¼€å§‹æ‰§è¡Œ2019-06-22æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190623002052
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190623002052
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190623002052

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190623002052
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190623002052

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190623002053
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190623002053


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190623002055
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190623002055

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190623002057
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190623002057


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190623002057
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190623002057







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190623002057
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190623002057
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190623002058
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190623002058

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190623002058
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190623002058
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190623002059
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190623002059
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190623002100
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190623002100
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190623002101
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190623002101

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,''
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190623002105

20190624091549å¼€å§‹æ‰§è¡Œ2019-06-23æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624091549
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624091549
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624091549

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624091549
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624091549

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624091550
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624091550


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624091551
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624091551

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624091553
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624091553


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624091554
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624091554







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624091554
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624091554
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624091554
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624091554

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624091555
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624091555
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624091556
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624091556
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624091557
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624091557
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624091558
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190624091558

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,''
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190624091602

20190625002104å¼€å§‹æ‰§è¡Œ2019-06-24æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190625002104
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190625002104
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190625002104

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190625002104
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190625002104

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190625002105
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190625002105


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190625002106
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190625002106

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190625002109
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190625002109


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190625002109
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190625002109







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190625002109
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190625002109
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190625002109
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190625002109

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190625002110
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190625002110
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190625002111
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190625002111
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190625002112
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190625002112
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190625002113
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190625002113

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,''
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190625002116

20190626145342å¼€å§‹æ‰§è¡Œ2019-06-25æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190626145342
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190626145342
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190626145342

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190626145342
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190626145342

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190626145343
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190626145343


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190626145345
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190626145345

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190626145347
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190626145347


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190626145347
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190626145347







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190626145347
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190626145347
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190626145348
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190626145348

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190626145348
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190626145348
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190626145349
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190626145349
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190626145350
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190626145350
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190626145351
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190626145351

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,''
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190626145355

20190627002108å¼€å§‹æ‰§è¡Œ2019-06-26æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190627002108
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190627002109
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190627002109

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190627002109
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190627002109

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190627002110
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190627002110


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190627002111
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190627002111

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190627002113
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190627002113


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190627002114
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190627002114







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190627002114
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190627002114
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190627002114
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190627002114

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190627002115
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190627002115
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190627002116
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190627002116
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190627002116
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190627002116
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190627002117
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190627002117

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,''
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190627002121

20190628002138å¼€å§‹æ‰§è¡Œ2019-06-27æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190628002138
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190628002138
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190628002138

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190628002138
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190628002138

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190628002139
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190628002139


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190628002140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190628002140

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190628002142
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190628002142


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190628002143
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190628002143







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190628002143
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190628002143
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190628002143
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190628002143

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190628002144
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190628002144
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190628002145
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190628002145
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190628002146
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190628002146
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190628002147
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190628002147

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,''
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190628002151

20190702084326å¼€å§‹æ‰§è¡Œ2019-07-01æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702084326
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702084326
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702084326

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702084326
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702084326

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702084327
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702084327


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702084329
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702084329

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702084331
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702084331


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702084331
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702084331







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702084331
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702084331
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702084332
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702084332

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702084332
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702084332
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702084333
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702084333
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702084334
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702084334
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702084335
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702084335

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,''
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702084339

20190702092506å¼€å§‹æ‰§è¡Œ2019-07-01æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702092506
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702092506
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702092506

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702092506
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702092506

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702092507
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702092507


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702092509
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702092509

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702092511
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702092511


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702092511
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702092511







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702092511
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702092511
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702092512
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702092512

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702092512
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702092512
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702092513
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702092513
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702092514
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702092514
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702092515
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190702092515

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,''
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190702092519

20190703002124å¼€å§‹æ‰§è¡Œ2019-07-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190703002124
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190703002124
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190703002124

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190703002124
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190703002124

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190703002125
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190703002125


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190703002126
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190703002126

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190703002129
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190703002129


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190703002129
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190703002129







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190703002129
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190703002129
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190703002129
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190703002129

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190703002130
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190703002130
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190703002131
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190703002131
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190703002132
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190703002132
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190703002133
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190703002133

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,''
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190703002137

20190704002131å¼€å§‹æ‰§è¡Œ2019-07-03æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190704002131
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190704002131
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190704002131

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190704002131
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190704002131

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190704002132
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190704002132


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190704002133
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190704002133

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190704002136
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190704002136


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190704002136
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190704002136







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190704002136
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190704002136
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,''
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190704002137
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190704002137

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190704002137
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190704002137
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190704002138
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190704002138
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190704002139
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190704002139
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190704002140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190704002140

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,''
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190704002144

20190705002156å¼€å§‹æ‰§è¡Œ2019-07-04æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190705002156
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190705002156
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190705002156

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190705002156
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190705002156

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190705002157
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190705002157


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190705002159
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190705002159

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190705002201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190705002201


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190705002201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190705002201







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190705002201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190705002201
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190705002202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190705002202

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190705002203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190705002203
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190705002204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190705002204
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190705002205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190705002205
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190705002206
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190705002206

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190705002210

20190706002204å¼€å§‹æ‰§è¡Œ2019-07-05æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190706002204
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190706002204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190706002204

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190706002204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190706002204

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190706002205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190706002205


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190706002207
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190706002207

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190706002209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190706002209


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190706002210
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190706002210







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190706002210
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190706002210
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190706002210
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190706002210

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190706002211
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190706002211
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190706002212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190706002212
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190706002213
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190706002213
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190706002214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190706002214

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190706002218

20190707002207å¼€å§‹æ‰§è¡Œ2019-07-06æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190707002207
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190707002207
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190707002207

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190707002207
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190707002207

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190707002208
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190707002208


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190707002210
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190707002210

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190707002212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190707002212


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190707002212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190707002212







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190707002212
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190707002212
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190707002213
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190707002213

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190707002214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190707002214
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190707002215
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190707002215
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190707002216
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190707002216
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190707002217
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190707002217

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190707002221

20190708002229å¼€å§‹æ‰§è¡Œ2019-07-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190708002229
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190708002229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190708002229

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190708002229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190708002229

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190708002230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190708002230


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190708002232
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190708002232

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190708002234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190708002234


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190708002234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190708002234







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190708002234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190708002234
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190708002235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190708002235

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190708002236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190708002236
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190708002237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190708002237
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190708002238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190708002238
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190708002239
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190708002239

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190708002243

20190709002215å¼€å§‹æ‰§è¡Œ2019-07-08æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190709002215
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190709002215
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190709002215

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190709002215
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190709002215

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190709002216
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190709002216


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190709002218
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190709002218

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190709002221
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190709002221


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190709002221
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190709002221







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190709002221
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190709002221
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190709002222
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190709002222

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190709002222
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190709002222
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190709002223
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190709002223
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190709002224
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190709002224
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190709002225
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190709002225

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190709002230

20190710002220å¼€å§‹æ‰§è¡Œ2019-07-09æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190710002220
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190710002220
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190710002220

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190710002220
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190710002220

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190710002221
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190710002221


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190710002223
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190710002223

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190710002226
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190710002226


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190710002226
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190710002226







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190710002226
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190710002226
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190710002227
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190710002227

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190710002227
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190710002227
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190710002228
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190710002228
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190710002229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190710002229
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190710002230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190710002230

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190710002235

20190711002224å¼€å§‹æ‰§è¡Œ2019-07-10æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190711002224
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190711002224
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190711002224

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190711002224
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190711002224

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190711002225
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190711002225


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190711002227
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190711002227

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190711002230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190711002230


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190711002230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190711002230







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190711002230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190711002230
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190711002231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190711002231

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190711002231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190711002231
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190711002232
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190711002232
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190711002233
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190711002233
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190711002234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190711002234

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190711002239

20190712002243å¼€å§‹æ‰§è¡Œ2019-07-11æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190712002243
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190712002243
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190712002243

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190712002243
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190712002243

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190712002244
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190712002244


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190712002246
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190712002246

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190712002248
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190712002248


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190712002248
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190712002248







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190712002249
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190712002249
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190712002249
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190712002249

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190712002250
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190712002250
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190712002251
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190712002251
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190712002252
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190712002252
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190712002253
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190712002253

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190712002258

20190715091030å¼€å§‹æ‰§è¡Œ2019-07-14æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091030
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091030
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091030

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091030
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091030

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091031
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091031


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091033
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091033

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091036


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091036







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091036
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091037

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091037
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091038
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091039
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091039
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091040
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091040

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091045
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091045


create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where status = 2

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091045
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091045

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del1
;

20190715091201å¼€å§‹æ‰§è¡Œ2019-07-14æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091201
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091201

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091201

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091202


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091204

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091206
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091206


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091207
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091207







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091207
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091207
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091208
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091208

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091208
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091208
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091209
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091210
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091210
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091211
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091211

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091216
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091216


create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where status = 2

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091216
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091216

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091216
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091216

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091216
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190715091216

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190715091216

20190716004356å¼€å§‹æ‰§è¡Œ2019-07-15æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716004356
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716004356
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716004356

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716004356
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716004356

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716004358
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716004358


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716004359
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716004359

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716004402
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716004402


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716004402
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716004402







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716004402
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716004402
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716004403
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716004403

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716004404
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716004404
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716004405
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716004405
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716004406
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716004406
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716004407
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716004407

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716004412
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716004412


create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where status = 2

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716004412
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716004412

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716004412
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716004412

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716004412
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190716004412

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190716004412

20190717002243å¼€å§‹æ‰§è¡Œ2019-07-16æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717002243
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717002243
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717002243

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717002243
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717002243

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717002244
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717002244


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717002246
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717002246

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717002248
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717002248


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717002249
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717002249







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717002249
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717002249
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717002249
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717002249

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717002250
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717002250
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717002251
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717002251
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717002252
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717002252
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717002253
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717002253

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717002258
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717002258


create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where status = 2

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717002258
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717002258

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717002258
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717002258

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717002258
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717002258

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717002258
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190717002258

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190717002258

20190718002304å¼€å§‹æ‰§è¡Œ2019-07-17æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718002304
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718002304
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718002304

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718002304
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718002304

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718002305
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718002305


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718002307
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718002307

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718002309
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718002309


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718002310
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718002310







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718002310
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718002310
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718002311
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718002311

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718002311
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718002311
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718002312
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718002312
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718002313
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718002313
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718002315
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718002315

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718002319
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718002319


create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where status = 2

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718002320
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718002320

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718002320
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718002320

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718002320
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718002320

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718002320
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190718002320

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190718002320

20190719002250å¼€å§‹æ‰§è¡Œ2019-07-18æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719002250
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719002250
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719002250

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719002250
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719002250

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719002251
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719002251


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719002253
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719002253

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719002255
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719002255


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719002256
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719002256







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719002256
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719002256
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719002256
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719002256

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719002257
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719002257
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719002258
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719002258
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719002259
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719002259
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719002300
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719002300

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719002305
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719002305


create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where status = 2

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719002305
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719002305

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719002305
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719002305

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719002305
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719002305

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719002305
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190719002305

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190719002305

20190720002214å¼€å§‹æ‰§è¡Œ2019-07-19æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720002214
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720002214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720002214

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720002214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720002214

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720002215
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720002215


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720002217
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720002217

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720002219
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720002219


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720002220
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720002220







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720002220
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720002220
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720002220
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720002220

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720002221
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720002221
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720002222
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720002222
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720002223
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720002223
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720002224
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720002224

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720002229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720002229


create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where status = 2

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720002229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720002229

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720002229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720002229

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720002229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720002229

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720002229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190720002229

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190720002229

20190721002220å¼€å§‹æ‰§è¡Œ2019-07-20æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721002220
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721002220
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721002220

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721002220
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721002220

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721002221
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721002221


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721002223
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721002223

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721002225
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721002225


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721002226
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721002226







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721002226
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721002226
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721002227
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721002227

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721002227
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721002227
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721002228
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721002228
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721002229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721002229
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721002231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721002231

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721002235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721002235


create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where status = 2

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721002235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721002235

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721002235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721002235

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721002235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721002235

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721002235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190721002235

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190721002235

20190722002221å¼€å§‹æ‰§è¡Œ2019-07-21æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722002221
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722002221
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722002221

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722002221
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722002221

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722002222
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722002222


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722002223
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722002223

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722002226
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722002226


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722002226
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722002226







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722002226
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722002226
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722002227
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722002227

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722002228
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722002228
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722002229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722002229
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722002230
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722002230
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722002231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722002231

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722002236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722002236


create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where status = 2

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722002236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722002236

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722002236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722002236

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722002236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722002236

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722002236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190722002236

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190722002236

20190723002229å¼€å§‹æ‰§è¡Œ2019-07-22æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723002229
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723002229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723002229

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723002229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723002229

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723002231
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723002231


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723002232
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723002232

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723002235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723002235


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723002235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723002235







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723002235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723002235
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723002236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723002236

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723002237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723002237
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723002238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723002238
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723002239
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723002239
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723002240
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723002240

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,case when e.ccusname is not null then e.bi_cuscode end
      ,case when e.ccusname is not null then e.bi_cusname end
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723002245
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723002245


create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where status = 2

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723002245
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723002245

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723002245
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723002245

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723002245
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723002245

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723002245
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190723002245

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190723002245

20190724085625å¼€å§‹æ‰§è¡Œ2019-07-23æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724085625
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724085625
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724085625

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724085625
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724085625

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724085626
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724085626


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724085628
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724085628

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724085631
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724085631


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724085631
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724085631







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724085631
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724085631
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724085632
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724085632

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724085632
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724085632
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724085633
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724085633
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724085634
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724085634
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724085636
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724085636

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724085640
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724085640


create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where status = 2

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724085640
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724085640

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724085640
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724085640

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724085640
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724085640

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724085640
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190724085640

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190724085641

20190725091158å¼€å§‹æ‰§è¡Œ2019-07-24æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725091158
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725091159
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725091159

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725091159
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725091159

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725091200
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725091200


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725091202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725091202

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;

20190725091338å¼€å§‹æ‰§è¡Œ2019-07-24æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725091338
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725091338
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725091338

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725091338
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725091338

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725091339
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725091339


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725091341
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725091341

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;

20190725091728å¼€å§‹æ‰§è¡Œ2019-07-24æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725091728
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725091728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725091728

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725091728
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725091728

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725091729
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725091729


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725091731
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725091731

create temporary table pdm.account_fy_pre2 as
select i_id
      ,db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;

20190725092017å¼€å§‹æ‰§è¡Œ2019-07-24æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725092017
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725092017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725092017

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725092017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725092017

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725092018
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725092018


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725092020
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725092020

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725092022
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725092022


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725092023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725092023







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725092023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725092023
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725092023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725092023

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725092024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725092024
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725092025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725092025
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725092026
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725092026
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725092027
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725092027

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725092032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725092032


create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where status = 2

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725092032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725092032

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725092032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725092032

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725092032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725092032

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725092032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190725092032

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190725092032

20190726001856å¼€å§‹æ‰§è¡Œ2019-07-25æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001856
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001856
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001856

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001856
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001856

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,substring(liuchengbh,1, 20) as liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdepname_lv1 is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001857
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001857


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001859
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001859

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001902
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001902


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001902
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001902







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001902
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001902
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001903
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001903

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001904
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001904
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001905
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001905
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001905
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001905
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001907
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001907

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001911
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001911


create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where status = 2

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001912
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001912

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001912
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001912

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001912
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001912

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001912
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190726001912

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190726001912

20190727001918å¼€å§‹æ‰§è¡Œ2019-07-26æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001918
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001918
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001918

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001918
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001918

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001919
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001919


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001921
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001921

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001924
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001924


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001924
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001924







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001924
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001924
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001925
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001925

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001926
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001926
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001927
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001927
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001928
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001928
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001929
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001929

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001935
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001935

update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001935
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001935

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001935
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001935

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001935
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001935

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001936
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190727001936

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190727001936

20190728001913å¼€å§‹æ‰§è¡Œ2019-07-27æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001913
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001913
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001913

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001913
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001913

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001914
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001914


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001916
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001916

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001919
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001919


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001919
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001919







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001919
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001919
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001920
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001920

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001921
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001921
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001922
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001922
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001923
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001923
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001924
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001924

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001930
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001930

update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001930
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001930

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001930
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001930

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001930
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001930

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001930
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190728001930

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190728001930

20190729001912å¼€å§‹æ‰§è¡Œ2019-07-28æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001912
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001912
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001912

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001912
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001912

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001913
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001913


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001916
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001916

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001918
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001918


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001919
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001919







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001919
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001919
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001919
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001919

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001920
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001920
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001921
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001921
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001922
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001922
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001923
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001923

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001929
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001929

update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001929
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001929

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001929
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001929

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001929
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001929

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001930
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190729001930

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190729001930

20190730084531å¼€å§‹æ‰§è¡Œ2019-07-29æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730084531
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730084531
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730084531

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730084531
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730084531

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730084532
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730084532


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730084535
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730084535

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730084537
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730084537


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730084538
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730084538







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730084538
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730084538
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730084538
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730084538

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730084539
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730084539
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730084540
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730084540
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730084541
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730084541
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730084542
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730084542

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730084548
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730084548

update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730084548
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730084548

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730084548
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730084548

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730084548
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730084548

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730084549
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190730084549

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190730084549

20190731002006å¼€å§‹æ‰§è¡Œ2019-07-30æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731002006
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731002006

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731002006

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731002007
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731002007


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731002009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731002009

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731002012


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731002012







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731002012
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731002013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731002013

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731002013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731002013
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731002015
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731002016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731002016
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731002017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731002017

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731002023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731002023

update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731002023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731002023

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731002023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731002023

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731002023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731002023

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731002023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190731002023

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190731002023

20190801001935å¼€å§‹æ‰§è¡Œ2019-07-31æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001935
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001935
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001935

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001935
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001935

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001936
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001936


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001938

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001941
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001941


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001941
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001941







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001942
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001942
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001942
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001942

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001943
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001943
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001944
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001944
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001945
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001945
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001946
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001946

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001952

update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001952

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001952

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001952

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001953
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190801001953

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190801001953

20190802001949å¼€å§‹æ‰§è¡Œ2019-08-01æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802001949
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802001949
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802001949

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802001949
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802001949

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802001950
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802001950


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802001952

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802001955
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802001955


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802001955
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802001955







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802001955
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802001955
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802001956
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802001956

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802001957
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802001957
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802001958
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802001958
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802001959
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802001959
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802002000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802002000

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802002006

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802002006

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802002006

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802002006

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802002006

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802002006



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802002006

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802002006

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802002006

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802002006

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802002007
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802002007
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802002007
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802002007

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802002007
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190802002007

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190802002007

20190803002011å¼€å§‹æ‰§è¡Œ2019-08-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002011
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002011
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002011

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002011
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002011

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002012


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002014

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002017


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002017







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002017
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002018
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002018

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002019
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002019
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002020
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002020
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002021
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002021
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002022
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002022

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002028
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002028

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002028
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002028

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002028
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002028

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002028
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002028

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002028
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002028

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002029
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002029



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002029
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002029

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002029
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002029

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002029
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002029

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002029
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002029

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002029
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002029
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002029
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002029

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002029
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190803002029

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190803002030

20190804001959å¼€å§‹æ‰§è¡Œ2019-08-03æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804001959
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002000

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002000

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002001


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002003

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002006


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002006







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002006
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002007
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002007

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002008
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002008
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002009
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002010
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002011
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002011

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002017

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002017

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002017

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002017

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002017

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002017



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002017

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002018
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002018

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002018
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002018

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002018
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002018

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002018
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002018
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002018
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002018

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002018
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190804002018

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190804002018

20190805002002å¼€å§‹æ‰§è¡Œ2019-08-04æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002002
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002002

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002002

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002004
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002004


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002006

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002009


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002009







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002009
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002010

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002011
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002011
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002012
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002013
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002014

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002020
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002020

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002020
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002020

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002020
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002020

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002020
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002020

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002020
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002020

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002020
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002020



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002021
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002021

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002021
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002021

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002021
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002021

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002021
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002021

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002021
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002021
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002021
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002021

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002021
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190805002021

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190805002021

20190806001934å¼€å§‹æ‰§è¡Œ2019-08-05æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001934
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001934
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001934

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001934
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001934

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001935
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001935


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001937
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001937

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001940
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001940


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001940
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001940







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001940
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001940
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001941
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001941

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001942
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001942
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001943
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001943
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001944
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001944
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001945
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001945

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001951
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001951

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001951
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001951

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001951
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001951

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001951
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001951

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001951
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001951

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001952



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001952

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001952

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001952

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001952

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001952
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001952

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190806001952

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190806001952

20190807002004å¼€å§‹æ‰§è¡Œ2019-08-06æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002004
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002004
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002004

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002004
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002004

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002005
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002005


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002007
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002007

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002010


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002010







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002010
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002011
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002011

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002012
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002013
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002014
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002015

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002021
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002021

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002022
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002022

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002022
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002022

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002022
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002022

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002022
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002022

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002022
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002022



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002022
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002022

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002022
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002022

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002022
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002022

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002022
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002022

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002022
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002022
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002022
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002022

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002022
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190807002022

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190807002023

20190808001934å¼€å§‹æ‰§è¡Œ2019-08-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001934
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001934
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001934

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001934
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001934

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001935
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001935


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001938

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001940
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001940


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001941
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001941







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001941
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001941
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001942
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001942

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001942
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001942
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001944
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001944
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001945
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001945
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001946
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001946

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001952

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001952

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001952

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001952

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001952

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001952



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001952

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001953
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001953

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001953
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001953

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001953
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001953

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001953
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001953
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001953
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001953

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001953
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190808001953

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190808001953

20190809001950å¼€å§‹æ‰§è¡Œ2019-08-08æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809001950
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809001950
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809001950

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809001950
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809001950

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809001952


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809001954
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809001954

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809001956
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809001956


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809001957
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809001957







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809001957
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809001957
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809001958
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809001958

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809001959
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809001959
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809002000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809002000
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809002001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809002001
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809002002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809002002

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809002008
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809002008

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809002008
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809002008

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809002008
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809002008

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809002008
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809002008

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809002008
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809002008

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809002009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809002009



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809002009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809002009

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809002009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809002009

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809002009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809002009

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809002009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809002009

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809002009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809002009
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809002009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809002009

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809002009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190809002009

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190809002009

20190812084225å¼€å§‹æ‰§è¡Œ2019-08-11æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084225
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084225
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084225

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084225
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084225

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084227
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084227


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084229

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084232
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084232


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084232
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084232







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084232
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084232
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084233
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084233

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084234
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084235
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084236
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084237

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084243
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084243

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084244
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084244

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084244
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084244

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084244
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084244

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084244
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084244

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084244
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084244



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084244
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084244

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084244
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084244

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084244
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084244

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084244
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084244

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084244
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084244
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084244
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084244

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084245
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190812084245

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190812084245

20190813001954å¼€å§‹æ‰§è¡Œ2019-08-12æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813001954
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813001954
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813001954

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813001954
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813001954

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813001955
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813001955


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813001957
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813001957

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813002000


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813002001







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813002001
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813002001

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813002002
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813002003
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002004
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813002004
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813002006

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813002012

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813002012

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813002012

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813002012

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813002012

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813002012



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813002012

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813002012

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813002012

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813002013

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813002013
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813002013

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190813002013

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190813002013

20190814001956å¼€å§‹æ‰§è¡Œ2019-08-13æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814001956
create temporary table edw.code as
select ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814001956
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814001956

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814001956
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814001956

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814001957
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814001957


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814001959
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814001959

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814002002


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814002003







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814002003
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode else a.ccode end as ccode_lv2
      ,case when LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10 then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002004
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814002004

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002005
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814002005
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814002006
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002007
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814002007
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002008
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814002008

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814002014

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814002015

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814002015

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814002015

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814002015

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814002015



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814002015

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814002015

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814002015

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814002015

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814002015
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814002015

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190814002016

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190814002016

20190815001955å¼€å§‹æ‰§è¡Œ2019-08-14æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815001955
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815001955
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815001955

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815001955
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815001955

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815001956
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815001956


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815001959
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815001959

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815002002


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815002002







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815002002
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815002003

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002004
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815002004
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002005
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815002005
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815002006
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002007
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815002007

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815002014

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815002014

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815002014

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815002014

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815002014

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815002014



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815002014

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815002014

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815002014

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815002015

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815002015
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815002015

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190815002015

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190815002015

20190816001952å¼€å§‹æ‰§è¡Œ2019-08-15æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816001952
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816001953
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816001953

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816001953
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816001953

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816001954
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816001954


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816001956
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816001956

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816001959
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816001959


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816002000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816002000







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816002000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816002000
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816002001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816002001

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816002001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816002001
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816002002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816002002
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816002004
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816002004
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816002005
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816002005

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816002011
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816002011

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816002011
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816002011

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816002011
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816002011

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816002011
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816002011

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816002012

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816002012



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816002012

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816002012

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816002012

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816002012

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816002012
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816002012

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816002013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190816002013

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190816002013

20190817001956å¼€å§‹æ‰§è¡Œ2019-08-16æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817001956
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817001956
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817001956

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817001956
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817001956

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817001958
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817001958


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002000

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002003


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002003







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002003
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002004
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002004

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002005
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002005
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002006
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002007
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002007
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002009

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002015

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002015

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002015

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002015

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002016

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002016



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002016

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002016

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002016

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002016

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002016
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002016

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190817002017

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190817002017

20190818001923å¼€å§‹æ‰§è¡Œ2019-08-17æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001923
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001923
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001923

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001923
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001923

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001925
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001925


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001927
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001927

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001930
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001930


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001931
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001931







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001931
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001931
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001932
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001932

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001932
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001932
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001934
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001934
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001935
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001935
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001936
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001936

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001943
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001943

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001943
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001943

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001943
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001943

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001943
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001943

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001943
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001943

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001943
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001943



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001944
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001944

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001944
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001944

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001944
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001944

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001944
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001944

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001944
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001944
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001944
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001944

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001944
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190818001944

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190818001944

20190819001925å¼€å§‹æ‰§è¡Œ2019-08-18æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001925
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001925
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001925

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001925
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001925

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001926
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001926


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001929
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001929

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001931
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001931


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001932
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001932







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001932
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001932
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001933
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001933

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001934
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001934
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001935
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001935
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001936
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001936
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001937
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001937

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001944
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001944

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001944
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001944

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001944
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001944

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001944
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001944

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001944
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001944

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001944
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001944



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001945
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001945

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001945
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001945

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001945
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001945

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001945
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001945

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001945
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001945
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001945
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001945

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001945
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190819001945

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190819001945

20190820001930å¼€å§‹æ‰§è¡Œ2019-08-19æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001930
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001930
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001930

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001930
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001930

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001931
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001931


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001933
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001933

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001936
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001936


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001937
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001937







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001937
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001937
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001938
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001938

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001939
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001939
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001940
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001940
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001941
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001941
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001943
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001943

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001949
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001949

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001949
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001949

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001949
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001949

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001949
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001949

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001949
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001949

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001950
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001950



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001950
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001950

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001950
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001950

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001950
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001950

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001950
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001950

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001950
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001950
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001950
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001950

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001950
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190820001950

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190820001951

20190821002003å¼€å§‹æ‰§è¡Œ2019-08-20æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002003
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002003

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002003
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002003

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002005
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002005


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002007
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002007

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002010


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002011
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002011







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002011
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002011
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002012

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002013
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002014
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002015
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002016

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002023

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002023

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002023

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002023

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002023

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002023



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002024

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002024

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002024

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002024

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002024
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002024

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190821002024

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190821002025

20190822001945å¼€å§‹æ‰§è¡Œ2019-08-21æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001945
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001945
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001945

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001945
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001945

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001947
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001947


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001949
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001949

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001952


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001953
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001953







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001953
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001953
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001954
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001954

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001954
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001954
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001956
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001956
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001957
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001957
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822001958
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822001958

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822002005
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822002005

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822002005
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822002005

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822002005
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822002005

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822002005
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822002005

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822002005
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822002005

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822002005
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822002005



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822002006

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822002006

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822002006

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822002006

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822002006
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822002006

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190822002006

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190822002006

20190823001953å¼€å§‹æ‰§è¡Œ2019-08-22æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823001953
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823001953
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823001953

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823001953
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823001953

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823001954
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823001954


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823001957
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823001957

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002000
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823002000


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823002001







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002001
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823002001
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823002002

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002002
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823002002
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002004
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823002004
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002005
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823002005
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823002006

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823002013

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823002013

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823002013

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823002013

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823002013

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823002013



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823002014

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823002014

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823002014

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823002014

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823002014
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823002014

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190823002014

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190823002015

20190824002018å¼€å§‹æ‰§è¡Œ2019-08-23æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002018
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002018
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002018

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002018
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002018

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002019
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002019


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002022
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002022

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002025


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002025







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002025
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002026
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002026

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002027
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002027
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002028
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002028
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002029
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002029
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002031
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002031

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002038

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002038

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002038

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002038

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002038

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002038



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002038

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002038

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002039
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002039

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002039
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002039

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002039
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002039
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002039
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002039

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002039
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190824002039

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190824002039

20190825002009å¼€å§‹æ‰§è¡Œ2019-08-24æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002009
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002010

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002010

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002011
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002011


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002013

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002017


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002017







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002017
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002018
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002018

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002019
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002019
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002020
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002020
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002021
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002021
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002023

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002030
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002030

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002030
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002030

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002030
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002030

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002030
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002030

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002030
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002030

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002030
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002030



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002030
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002030

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002030
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002030

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002030
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002030

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002031
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002031

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002031
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002031
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002031
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002031

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002031
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190825002031

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190825002031

20190826002005å¼€å§‹æ‰§è¡Œ2019-08-25æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002005
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002005
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002005

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002005
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002005

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002006
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002006


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002009
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002009

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002012


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002012







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002013
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002013

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002014
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002015
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002017
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002018
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002018

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002025

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002025

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002025

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002025

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002025

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002025



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002025

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002026
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002026

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002026
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002026

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002026
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002026

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002026
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002026
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002026
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002026

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002026
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190826002026

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190826002026

20190828085325å¼€å§‹æ‰§è¡Œ2019-08-27æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085325
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085325
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085325

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085325
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085325

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085327
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085327


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085329
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085329

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085332
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085332


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085333
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085333







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085333
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085333
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085334
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085334

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085335
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085335
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085336
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085336
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085337
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085337
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085339
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085339

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085345
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085345

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085346
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085346

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085346
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085346

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085346
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085346

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085346
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085346

delete from pdm.account_fy where md = 0
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085346
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085346



update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085346
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085346

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085346
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085346

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085346
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085346

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085346
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085346

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085346
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085346
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085347
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085347

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085347
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190828085347

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190828085347

20190829002016å¼€å§‹æ‰§è¡Œ2019-08-28æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002016
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002016

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002016

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002018
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002018


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002020
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002020

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002023


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002024







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002024
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002025

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002026
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002026
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002027
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002027
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002028
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002028
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002030
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002030

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002037

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002037

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002037

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002037

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002037




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002037

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002037

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002037

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002037

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002038
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002038

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002038

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002038


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190829002038

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190829002039

20190830002024å¼€å§‹æ‰§è¡Œ2019-08-29æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002024
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002024

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002024

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002026
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002026


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002028
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002028

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002032


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002032







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002032
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002033
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002033

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002034
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002035
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002036
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002038

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002045
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002045

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002045
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002045

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002045
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002045

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002045
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002045

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002045
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002045




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002046

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002046

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002046

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002046

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002046
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002046

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002046

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002046


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002047
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190830002047

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190830002047

20190831001945å¼€å§‹æ‰§è¡Œ2019-08-30æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831001945
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831001945
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831001945

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831001945
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831001945

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831001946
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831001946


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831001949
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831001949

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831001952
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831001952


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831001953
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831001953







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190831001953
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190831001953
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;

20190902093143å¼€å§‹æ‰§è¡Œ2019-09-01æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093143
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093143
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093143

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093143
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093143

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093145
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093145


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093147
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093147

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093151
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093151


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093151
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093151







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093151
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093151
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,''
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093152
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093152

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093153
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093153
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093154
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093154
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093155
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093155
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093157
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093157

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093204

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093204

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093204

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093204

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,''
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093204




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093204

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093204

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093204

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093204

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093205
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093205

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093205

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093205


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902093205

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902093206

20190902094646å¼€å§‹æ‰§è¡Œ2019-09-01æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094646
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094646
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094646

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094646
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094646

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094647
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094647


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094650
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094650

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094653
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094653


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094654
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094654







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094654
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094654
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,''
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094655
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094655

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094655
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094655
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094657
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094657
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094658
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094658
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094700
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094700

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094707

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094707

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094707

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094707

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,''
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094707




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094707

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094707

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094707

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094707

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094707
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094707
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094708
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094708

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094708
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094708

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094708
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094708


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094708
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190902094708

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190902094709

20190903002010å¼€å§‹æ‰§è¡Œ2019-09-02æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002010
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002010

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002010
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002010

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002012


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002015

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002018
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002018


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002018
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002018







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002018
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002018
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,''
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002019
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002019

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002020
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002020
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002021
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002021
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002023
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002024

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002031
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002031

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002031
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002031

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002031
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002031

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002032

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,''
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002032




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002032

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002032

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002032

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002032

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002032
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002032

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002033
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002033

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002033
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002033


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002033
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190903002033

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190903002034

20190904105820å¼€å§‹æ‰§è¡Œ2019-09-03æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105820
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105820
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105820

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105820
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105820

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105821
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105821


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105824
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105824

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105827
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105827


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105828
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105828







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105828
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105828
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,''
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105829
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105829

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105830
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105830
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105831
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105831
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105832
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105832
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105834
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105834

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105841
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105841

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105841
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105841

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105841
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105841

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105841
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105841

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,''
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105842
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105842




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105842
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105842

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105842
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105842

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105842
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105842

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105842
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105842

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105842
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105842
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105842
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105842

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105843
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105843

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105843
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105843


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105843
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190904105843

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190904105843

20190905002012å¼€å§‹æ‰§è¡Œ2019-09-04æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002012
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002012

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002012
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002012

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002014
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002014


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002016

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002020
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002020


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002020
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002020







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002020
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002020
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,''
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002021
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002021

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002022
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002022
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002023
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002025
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002026
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002026

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002034

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002034

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002034

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002034

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,''
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002034




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002034

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002034

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002034

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002035

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002035
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002035

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002035

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002035


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190905002036

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190905002036

20190906002013å¼€å§‹æ‰§è¡Œ2019-09-05æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002013
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002013

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002013
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002013

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002015


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002017
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002017

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002021
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002021


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002021
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002021







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002021
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002021
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,''
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,''
      ,''
      ,''
      ,a.voucher_id
      ,''
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,''
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002022
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002022

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002023
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002024
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002026
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002026
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002027
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002027

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002035

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002035

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002035

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002035

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,''
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002035




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002035

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002035

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002035

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002035

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002036
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002036

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002036

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002036


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190906002036

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190906002037

20190907002035å¼€å§‹æ‰§è¡Œ2019-09-06æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002035
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002035

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002035

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002037


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002040
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002040

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002043
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002043


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002044
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002044







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002044
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002044
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002045
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002045

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002045
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002045
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002047
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002047
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002048
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002048
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002050
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002050

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002057
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002057

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002058
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002058

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002058
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002058

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002058
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002058

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002058
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002058




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002058
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002058

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002058
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002058

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002058
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002058

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002058
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002058

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002058
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002058
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002059
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002059

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002059
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002059

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002059
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002059


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002059
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190907002059

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190907002059

20190908002032å¼€å§‹æ‰§è¡Œ2019-09-07æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002032
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002032

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002032

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002033
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002033


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002036

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002040
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002040


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002040
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002040







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002040
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002040
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002041
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002041

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002042
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002042
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002043
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002043
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002045
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002045
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002046

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002054
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002054

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002054
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002054

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002054
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002054

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002054
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002054

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002054
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002054




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002054
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002054

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002054
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002054

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002054
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002054

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002055
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002055

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002055
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002055
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002055
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002055

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002055
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002055

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002055
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002055


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002055
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190908002055

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190908002056

20190909002024å¼€å§‹æ‰§è¡Œ2019-09-08æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002024
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002024

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002024

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002026
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002026


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002028
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002028

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002032


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002032







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002032
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002032
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002033
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002033

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002034
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002034
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002035
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002035
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002037
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002038

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002046

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002046

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002046

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002046

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002046




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002046

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002046

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002046
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002046

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002047
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002047

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002047
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002047
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002047
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002047

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002047
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002047

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002047
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002047


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002047
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190909002047

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190909002048

20190910002014å¼€å§‹æ‰§è¡Œ2019-09-09æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002014
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002015

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002015
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002015

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002016
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002016


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002019
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002019

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002022
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002022


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002023







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002023
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002023
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002024
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002024

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002025
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002025
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002026
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002026
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002027
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002027
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002029
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002029

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002036

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002036

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002036

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002036

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002036
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002036




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002037

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002037

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002037

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002037

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002037
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002037
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002037

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002038

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002038


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002038
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190910002038

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190910002038

20190911002039å¼€å§‹æ‰§è¡Œ2019-09-10æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002039
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002040
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002040

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002040
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002040

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002041
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002041


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002044
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002044

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002047
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002047


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002048
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002048







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002048
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002048
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002049
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002049

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002049
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002049
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002051
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002051
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002052
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002052
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002054
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002054

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002101
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002101

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002101
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002101

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002101
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002101

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002102
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002102

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002102
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002102




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002102
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002102

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002102
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002102

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002102
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002102

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002102
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002102

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002102
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002102
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002103
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002103

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002103
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002103

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002103
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002103


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002103
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190911002103

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190911002104

20190912002054å¼€å§‹æ‰§è¡Œ2019-09-11æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002054
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002054
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002054

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002054
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002054

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002055
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002055


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002058
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002058

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002102
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002102


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002102
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002102







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002102
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002102
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002103
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002103

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002104
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002104
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002105
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002105
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002107
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002107
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002108
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002108

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002116
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002116

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002116
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002116

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002116
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002116

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002116
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002116

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002117
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002117




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002117
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002117

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002117
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002117

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002117
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002117

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002117
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002117

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002117
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002117
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002118
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002118

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002118
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002118

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002118
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002118


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002118
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190912002118

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190912002118

20190913002106å¼€å§‹æ‰§è¡Œ2019-09-12æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002106
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002106
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002106

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002106
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002106

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002108
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002108


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002111
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002111

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002114
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002114


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002115
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002115







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002115
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002115
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002116
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002116

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002117
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002117
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002118
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002118
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002119
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002119
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002121
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002121

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002129
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002129

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002129
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002129

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002129
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002129

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002129
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002129

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002129
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002129




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002129
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002129

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002129
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002129

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002130
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002130

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002130
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002130

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002130
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002130
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002130
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002130

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002130
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002130

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002130
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002130


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002131
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190913002131

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190913002131

20190914002151å¼€å§‹æ‰§è¡Œ2019-09-13æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002151
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002152
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002152

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002152
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002152

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002153
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002153


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002156
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002156

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002159
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002159


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002200
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002200







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002200
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002200
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002201

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002202
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002203
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002205
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002206
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002206

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002214

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002214

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002214

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002214

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002214




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002215
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002215

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002215
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002215

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002215
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002215

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002215
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002215

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002215
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002215
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002215
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002215

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002216
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002216

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002216
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002216


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002216
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190914002216

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190914002216

20190915002048å¼€å§‹æ‰§è¡Œ2019-09-14æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002048
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002048
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002048

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002048
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002048

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002049
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002049


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002052
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002052

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002055
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002055


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002056
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002056







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002056
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002056
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002057
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002057

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002058
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002058
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002059
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002059
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002101
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002101
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002102
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002102

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002110
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002110

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002110
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002110

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002110
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002110

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002110
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002110

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002111
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002111




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002111
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002111

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002111
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002111

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002111
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002111

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002111
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002111

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002111
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002111
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002111
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002111

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002112
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002112

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002112
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002112


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002112
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190915002112

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190915002112

20190916002054å¼€å§‹æ‰§è¡Œ2019-09-15æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002055
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002055
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002055

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002055
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002055

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002056
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002056


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002059
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002059

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002103
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002103


create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002103
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002103







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002103
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002103
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode else a.ccode end as ccode_lv2
      ,case when a.db <> 'UFDATA_007_2019' and (LENGTH(a.ccode) = 8 or LENGTH(a.ccode) = 10) then b.ccode_name else a.ccode_name end as ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.code group by ccode,ccode_name) b
    on left(a.ccode,6) = b.ccode
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002104
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002104

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002105
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002105
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002106
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002106
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002108
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002108
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002109
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002109

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002117
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002117

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002117
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002117

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002117
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002117

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002117
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002117

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002118
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002118




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002118
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002118

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002118
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002118

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002118
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002118

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002118
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002118

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002118
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002118
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002118
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002118

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002119
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002119

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002119
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002119


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002119
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190916002119

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190916002119

20190917002118å¼€å§‹æ‰§è¡Œ2019-09-16æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002118
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002118
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002118

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002118
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002118

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002119
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002119


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002122
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002122

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002126
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002126

create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002126
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002126







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002126
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002126
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002127
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002127

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002128
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002128
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002129
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002129
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002131
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002131
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002132
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002132

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002140

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002141
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002141

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002141
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002141

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002141
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002141

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002141
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002141




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002141
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002141

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002141
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002141

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002141
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002141

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002141
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002141

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002142
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002142
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002142
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002142

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002142
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002142

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002142
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002142


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002142
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917002142

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917002143

20190917094136å¼€å§‹æ‰§è¡Œ2019-09-17æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094136
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094136
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094136

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094136
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094136

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094137
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094137


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094140

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094144
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094144

create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094144
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094144







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094144
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094144
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094145
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094145

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094146
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094146
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094148
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094148
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094149
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094150
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094150

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094158
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094158

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094158
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094158

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094158
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094158

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094159
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094159

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094159
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094159




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094159
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094159

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094159
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094159

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094159
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094159

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094159
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094159

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094159
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094159
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094200
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094200

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094200
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094200

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094200
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094200


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094200
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190917094200

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190917094200

20190918002126å¼€å§‹æ‰§è¡Œ2019-09-17æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002126
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002126
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002126

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002126
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002126

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002127
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002127


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002130
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002130

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002134
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002134

create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002134
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002134







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002134
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002134
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002135
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002135

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002136
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002136
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002138
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002138
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002139
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002139
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002141
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002141

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002149

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002149

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002149

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002149

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002149




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002149

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002149

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002149

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002150
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002150

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002150
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002150
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002150
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002150

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002150
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002150

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002150
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002150


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002150
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190918002150

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190918002151

20190919002116å¼€å§‹æ‰§è¡Œ2019-09-18æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002116
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002117
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002117

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002117
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002117

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002118
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002118


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002121
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002121

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002124
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002124

create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002125
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002125







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002125
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002125
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002126
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002126

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002127
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002127
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002128
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002128
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002130
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002130
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002131
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002131

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002139
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002139

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002140

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002140

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002140

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002140




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002140

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002140

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002141
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002141

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002141
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002141

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002141
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002141
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002141
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002141

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002141
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002141

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002141
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002141


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002141
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002141

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002142
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190919002142

update pdm.account_fy a
 inner join (select * from ufdata.department where db = 'UFDATA_111_2018' group by cdepcode) b
    on a.cdept_id = b.cdepcode
   set a.name_u8 = cdepname
 where a.db = 'UFDATA_118_2018'
    or a.db = 'UFDATA_123_2018'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190919002142

20190920002134å¼€å§‹æ‰§è¡Œ2019-09-19æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002134
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002134
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002134

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002134
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002134

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002135
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002135


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002138
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002138

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002142
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002142

create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002142
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002142







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002142
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002142
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002143
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002143

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002144
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002144
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002145
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002145
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002147
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002147
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002149

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002157
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002157

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002157
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002157

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002157
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002157

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002157
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002157

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002157
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002157




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002157
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002157

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002158
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002158

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002158
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002158

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002158
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002158

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002158
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002158
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002158
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002158

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002158
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002158

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002159
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002159


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002159
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002159

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002159
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190920002159

update pdm.account_fy a
 inner join (select * from ufdata.department where db = 'UFDATA_111_2018' group by cdepcode) b
    on a.cdept_id = b.cdepcode
   set a.name_u8 = cdepname
 where a.db = 'UFDATA_118_2018'
    or a.db = 'UFDATA_123_2018'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190920002200

20190921002125å¼€å§‹æ‰§è¡Œ2019-09-20æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002125
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002125
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002125

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002125
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002125

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002126
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002126


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002129
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002129

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002133
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002133

create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002133
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002133







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002133
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002133
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002134
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002134

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002135
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002135
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002137
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002137
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002138
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002138
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002140

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002148
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002148

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002148
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002148

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002148
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002148

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002149

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002149




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002149

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002149

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002149

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002149

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002150
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002150
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002150
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002150

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002150
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002150

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002150
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002150


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002150
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002150

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002151
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190921002151

update pdm.account_fy a
 inner join (select * from ufdata.department where db = 'UFDATA_111_2018' group by cdepcode) b
    on a.cdept_id = b.cdepcode
   set a.name_u8 = cdepname
 where a.db = 'UFDATA_118_2018'
    or a.db = 'UFDATA_123_2018'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190921002151

20190922002130å¼€å§‹æ‰§è¡Œ2019-09-21æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002130
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002130
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002130

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002130
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002130

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002131
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002131


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002134
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002134

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002138
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002138

create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002138
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002138







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002138
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002138
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002139
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002139

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002140
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002142
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002142
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002143
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002143
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002145
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002145

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002153
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002153

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002153
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002153

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002153
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002153

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002153
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002153

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002153
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002153




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002154
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002154

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002154
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002154

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002154
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002154

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002154
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002154

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002154
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002154
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002154
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002154

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002155
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002155

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002155
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002155


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002155
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002155

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002155
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190922002155

update pdm.account_fy a
 inner join (select * from ufdata.department where db = 'UFDATA_111_2018' group by cdepcode) b
    on a.cdept_id = b.cdepcode
   set a.name_u8 = cdepname
 where a.db = 'UFDATA_118_2018'
    or a.db = 'UFDATA_123_2018'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190922002156

20190923002214å¼€å§‹æ‰§è¡Œ2019-09-22æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002214
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002214

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002214

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002215
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002215


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002218
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002218

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002222
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002222

create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002222
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002222







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002222
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002222
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002223
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002223

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002224
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002224
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002226
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002226
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002227
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002227
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002229
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002229

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002237

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002237

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002237

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002237

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002237




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002237

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002238

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002238

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002238

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002238
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002238

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002238
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002238

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002239
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002239


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002239
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002239

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002239
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190923002239

update pdm.account_fy a
 inner join (select * from ufdata.department where db = 'UFDATA_111_2018' group by cdepcode) b
    on a.cdept_id = b.cdepcode
   set a.name_u8 = cdepname
 where a.db = 'UFDATA_118_2018'
    or a.db = 'UFDATA_123_2018'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190923002240

20190924002210å¼€å§‹æ‰§è¡Œ2019-09-23æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002210
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002210
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002210

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002210
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002210

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002211
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002211


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002214

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002218
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002218

create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002218
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002218







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002218
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002218
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002220
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002220

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002221
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002221
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002222
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002222
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002223
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002223
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002225
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002225

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002234

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002234

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002234

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002234

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002234
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002234




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002235

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002235

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002235

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002235

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002235
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002235
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002235

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002236

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002236


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002236
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002236

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002237
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190924002237

update pdm.account_fy a
 inner join (select * from ufdata.department where db = 'UFDATA_111_2018' group by cdepcode) b
    on a.cdept_id = b.cdepcode
   set a.name_u8 = cdepname
 where a.db = 'UFDATA_118_2018'
    or a.db = 'UFDATA_123_2018'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190924002237

20190925090832å¼€å§‹æ‰§è¡Œ2019-09-24æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090832
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090832
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090832

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090832
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090832

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090834
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090834


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090836
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090836

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090840
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090840

create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090841
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090841







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090841
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090841
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090842
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090842

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090843
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090843
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090844
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090844
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090846
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090846
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090847
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090847

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090856
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090856

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090856
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090856

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090856
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090856

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090856
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090856

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090856
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090856




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090857
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090857

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090857
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090857

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090857
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090857

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090857
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090857

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090857
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090857
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090857
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090857

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090858
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090858

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090858
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090858


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090858
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090858

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090859
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190925090859

update pdm.account_fy a
 inner join (select * from ufdata.department where db = 'UFDATA_111_2018' group by cdepcode) b
    on a.cdept_id = b.cdepcode
   set a.name_u8 = cdepname
 where a.db = 'UFDATA_118_2018'
    or a.db = 'UFDATA_123_2018'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190925090859

20190926002148å¼€å§‹æ‰§è¡Œ2019-09-25æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002148
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002149

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002149

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002150
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002150


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002153
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002153

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002157
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002157

create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002157
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002157







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002157
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002157
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002159
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002159

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002200
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002200
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002201
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002202
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002204

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002213
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002213

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002213
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002213

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002213
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002213

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002213
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002213

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002213
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002213




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002213
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002213

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002214

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002214

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002214

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002214
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002214

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002214
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002214

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002215
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002215


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002215
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002215

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002215
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190926002215

update pdm.account_fy a
 inner join (select * from ufdata.department where db = 'UFDATA_111_2018' group by cdepcode) b
    on a.cdept_id = b.cdepcode
   set a.name_u8 = cdepname
 where a.db = 'UFDATA_118_2018'
    or a.db = 'UFDATA_123_2018'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190926002216

20190927094136å¼€å§‹æ‰§è¡Œ2019-09-26æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094136
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094136
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094136

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094136
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094136

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094138
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094138


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094141
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094141

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094145
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094145

create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094145
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094145







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094145
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094145
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094146
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094146

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094147
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094147
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094149
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094150
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094150
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094152
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094152

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094201

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094201

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094201

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094201

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094201




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094202

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094202

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094202

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094202

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094202
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094202

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094203

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094203


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094203

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190927094204

update pdm.account_fy a
 inner join (select * from ufdata.department where db = 'UFDATA_111_2018' group by cdepcode) b
    on a.cdept_id = b.cdepcode
   set a.name_u8 = cdepname
 where a.db = 'UFDATA_118_2018'
    or a.db = 'UFDATA_123_2018'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190927094204

20190928002140å¼€å§‹æ‰§è¡Œ2019-09-27æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002140
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002140

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002140
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002140

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002142
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002142


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002145
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002145

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002148
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002148

create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002149







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002149
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002150
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002150

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002151
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002151
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002152
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002152
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002154
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002154
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002155
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002155

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002204

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002204

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002205

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002205

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002205




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002205

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002205

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002205

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002205
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002205

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002206
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002206
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002206
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002206

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002206
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002206

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002206
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002206


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002206
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002206

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002207
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002207

update pdm.account_fy a
 inner join (select * from ufdata.department where db = 'UFDATA_111_2018' group by cdepcode) b
    on a.cdept_id = b.cdepcode
   set a.name_u8 = cdepname
 where a.db = 'UFDATA_118_2018'
    or a.db = 'UFDATA_123_2018'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002207
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002207

update pdm.account_fy set kemu = '6602ä¸“ä¸šæœºæ„è´¹',code='66020015',code_name='ä¸“ä¸šæœºæ„è´¹',code_lv2='66020015',code_name_lv2 ='ä¸“ä¸šæœºæ„è´¹' where cohr = 'ç”„å…ƒ' and kemu = '6601ææ–™'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002208
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002208
update pdm.account_fy set kemu = '6601ä¼šåŠ¡è´¹',code='660128',code_name='ä¼šåŠ¡è´¹',code_lv2='660128',code_name_lv2 ='ä¼šåŠ¡è´¹' where cohr = 'å¥¥åšç‰¹' and kemu = '6601ä¼šåŠ¡æ‹›å¾…'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002208
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002208
update pdm.account_fy set kemu = '6601ä¼šåŠ¡è´¹',code='660128',code_name='ä¼šåŠ¡è´¹',code_lv2='660128',code_name_lv2 ='ä¼šåŠ¡è´¹' where cohr = 'ç¾åšç‰¹' and kemu = '6601ä¼šåŠ¡æ‹›å¾…'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002208
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002208
update pdm.account_fy set kemu = '6601ä¼šåŠ¡è´¹',code='660128',code_name='ä¼šåŠ¡è´¹',code_lv2='660128',code_name_lv2 ='ä¼šåŠ¡è´¹' where cohr = 'åšåœ£' and kemu = '6601ä¼šåŠ¡æ‹›å¾…'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002208
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002208
update pdm.account_fy set kemu = '6601ä¼šåŠ¡è´¹',code='660128',code_name='ä¼šåŠ¡è´¹',code_lv2='660128',code_name_lv2 ='ä¼šåŠ¡è´¹' where cohr = 'åšåœ£' and kemu = '6602ä¼šåŠ¡æ‹›å¾…'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002208
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002208
update pdm.account_fy set kemu = '6601äººå‘˜æˆæœ¬',code='6601010104',code_name='äº¤é€šè¡¥è´´',code_lv2='660101',code_name_lv2 ='äººå‘˜æˆæœ¬' where cohr = 'åšåœ£' and kemu = '6601äº¤é€šè¡¥è´´'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002209
update pdm.account_fy set kemu = '6601äººå‘˜æˆæœ¬',code='6601010104',code_name='äº¤é€šè¡¥è´´',code_lv2='660101',code_name_lv2 ='äººå‘˜æˆæœ¬' where cohr = 'ç¾åšç‰¹' and kemu = '6601äº¤é€šè¡¥è´´'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002209
update pdm.account_fy set kemu = '6602å†…éƒ¨ä¼šè®®è´¹',code='660204',code_name='å†…éƒ¨ä¼šè®®è´¹',code_lv2='660204',code_name_lv2 ='å†…éƒ¨ä¼šè®®è´¹' where cohr = 'ç”„å…ƒ' and kemu = '6602å†…éƒ¨ä¼šè®®è´¹'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002209
update pdm.account_fy set kemu = '6602ä¸“ä¸šæœºæ„è´¹',code='66020015',code_name='ä¸“ä¸šæœºæ„è´¹',code_lv2='66020015',code_name_lv2 ='ä¸“ä¸šæœºæ„è´¹' where cohr = 'ç”„å…ƒ' and kemu = '6602å¤–éƒ¨æœåŠ¡è´¹'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002209
update pdm.account_fy set kemu = '6403å°èŠ±ç¨',code='640305',code_name='å°èŠ±ç¨',code_lv2='640305',code_name_lv2 ='å°èŠ±ç¨' where cohr = 'æ©å…' and kemu = '6602å°èŠ±ç¨'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002209
update pdm.account_fy set kemu = '6403å°èŠ±ç¨',code='640305',code_name='å°èŠ±ç¨',code_lv2='640305',code_name_lv2 ='å°èŠ±ç¨' where cohr = 'å¥¥åšç‰¹' and kemu = '6602å°èŠ±ç¨'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002209
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002209
update pdm.account_fy set kemu = '6403å°èŠ±ç¨',code='640305',code_name='å°èŠ±ç¨',code_lv2='640305',code_name_lv2 ='å°èŠ±ç¨' where cohr = 'è´å®‰äº‘' and kemu = '6602å°èŠ±ç¨'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002210
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002210
update pdm.account_fy set kemu = '6601ä¼šåŠ¡è´¹',code='660128',code_name='ä¼šåŠ¡è´¹',code_lv2='660128',code_name_lv2 ='ä¼šåŠ¡è´¹' where cohr = 'ç¾åšç‰¹' and kemu = '6601é™¢å†…æ²™é¾™'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002210
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190928002210
update pdm.account_fy set kemu = '6601è€—æåŠé…ä»¶',code='660118',code_name='è€—æåŠé…ä»¶',code_lv2='660118',code_name_lv2 ='è€—æåŠé…ä»¶' where cohr = 'ç”„å…ƒ' and kemu = '6601è¿è¥è´¹ç”¨'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190928002210

20190929002135å¼€å§‹æ‰§è¡Œ2019-09-28æ•°æ®åŠ è½½æ—¥å¿—:
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002135
create temporary table edw.code as
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_111_2018'
   and iyear = "2019" union
select distinct ccode,ccode_name
  from ufdata.code
 where db = 'UFDATA_007_2019'
   and iyear = "2019"

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002135
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002135

insert into edw.code values('640110','äººå‘˜æˆæœ¬')
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002135
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002135

create temporary table pdm.accvouch_u8_pre as
select
db
,left(dbill_date,10) as dbill_date
,liuchengbh
,ccode_lv2
,ccode_name_lv2
,cdept_id
,cdepname
,cdepname_lv1
,cdepname_lv2
,cdepname_lv3
,cdepname_lv4
,cpersonname
,bi_cusname
,md
,ccode
,ccode_name
,i_id
,voucher_id
,sales_region
from edw.accvouch_u8
where dbill_date >= '2019-01-01'
  and left(ccode,2) in ('51','53','64','66')
  and cdept_id is not null
  and md <> 0

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002137
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002137


create temporary table pdm.accvouch_oa_pre as
select a.*
  from edw.accvouch_oa a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh) b
    on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is not null
   and left(a.oa_ccode,2) in ('51','53','64','66')

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002139
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002139

create temporary table pdm.account_fy_pre2 as
select i_id
      ,a.db
      ,case when a.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when a.db = 'UFDATA_118_2018' then 'å“æ©'
            when a.db = 'UFDATA_123_2018' then 'æ©å…'
            when a.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when a.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when a.db = 'UFDATA_222_2018' then 'å®è£'
            when a.db = 'UFDATA_222_2019' then 'å®è£'
            when a.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when a.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when a.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when a.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when a.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when a.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,dbill_date
      ,a.cdept_id
      ,a.cdepname
      ,cpersonname
      ,a.bi_cusname as kehumc
      ,ccode
      ,ccode_name
      ,concat(left(ccode,4),ccode_name) as sub_name
      ,ccode_lv2
      ,ccode_name_lv2
      ,cdepname_lv1
      ,cdepname_lv2
      ,cdepname_lv3
      ,cdepname_lv4
      ,md
      ,voucher_id
      ,a.liuchengbh as u8_liuchengbh
      ,a.sales_region as province
      from pdm.accvouch_u8_pre a
	left join (select * from pdm.accvouch_oa_pre group by liuchengbh) b
	  on a.liuchengbh = b.liuchengbh
 where b.liuchengbh is null 
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002143
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002143

create temporary table pdm.account_fy_pre3 as
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.cpersonname
      ,a.kehumc
      ,a.cdept_id
      ,a.cdepname
      ,a.cdepname_lv1
      ,a.cdepname_lv2
      ,a.cdepname_lv3
      ,a.cdepname_lv4
      ,a.voucher_id
      ,a.sub_name as u8dykm
      ,a.ccode as ccode
      ,b.ccode_name as ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,a.province
      ,'u8ç‹¬æœ‰' as state
  from pdm.account_fy_pre2 a
  left join (select * from edw.code group by ccode) b
    on a.ccode = b.ccode

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002144
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002144







truncate table pdm.account_fy
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002144
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002144
insert into pdm.account_fy
select a.i_id    
      ,a.db             
      ,a.cohr
      ,a.dbill_date
      ,null
      ,a.cpersonname
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cuscode
            else '' end
      ,case when a.kehumc is not null and e.ccusname is null then 'è¯·æ ¸æŸ¥'
            when a.kehumc is not null and e.ccusname is not null then e.bi_cusname
            else '' end
      ,a.kehumc
      ,a.province
      ,a.cdepname
      ,c.cdept_id_ehr
      ,c.name_ehr
      ,c.second_dept
      ,c.third_dept
      ,c.fourth_dept
      ,c.fifth_dept
      ,c.sixth_dept
      ,null
      ,null
      ,null
      ,a.voucher_id
      ,null
      ,null
      ,a.u8dykm
      ,a.ccode
      ,a.ccode_name
      ,a.ccode_lv2
      ,a.ccode_name_lv2
      ,a.md
      ,a.u8_liuchengbh
      ,null
      ,'u8ç‹¬æœ‰'
      ,a.cdept_id
      ,'å–'
  from pdm.account_fy_pre3 a
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on a.cdept_id = c.cdept_id
   and left(a.db,10) = left(c.db,10)
	left join (select * from edw.dic_customer group by ccusname) e
	  on a.kehumc = e.ccusname

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002145
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002145

create temporary table pdm.accvouch_u8_pre1 as select * from pdm.accvouch_u8_pre
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002146
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002146
CREATE INDEX index_accvouch_u8_pre1_liuchengbh ON pdm.accvouch_u8_pre1(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002147
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002147
CREATE INDEX index_accvouch_u8_pre_liuchengbh ON pdm.accvouch_u8_pre(liuchengbh)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002149
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002149
CREATE INDEX index_accvouch_u8_pre_md ON pdm.accvouch_u8_pre(md)
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002150
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002150

insert into pdm.account_fy
select f.i_id
      ,f.db
      ,case when f.db = 'UFDATA_111_2018' then 'åšåœ£' 
            when f.db = 'UFDATA_118_2018' then 'å“æ©'
            when f.db = 'UFDATA_123_2018' then 'æ©å…'
            when f.db = 'UFDATA_168_2018' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_168_2019' then 'æ­å·è´ç”Ÿ'
            when f.db = 'UFDATA_169_2018' then 'äº‘é¼'
            when f.db = 'UFDATA_222_2018' then 'å®è£'
            when f.db = 'UFDATA_222_2019' then 'å®è£'
            when f.db = 'UFDATA_333_2018' then 'å®æ³¢è´ç”Ÿ'
            when f.db = 'UFDATA_588_2018' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_588_2019' then 'å¥¥åšç‰¹'
            when f.db = 'UFDATA_666_2018' then 'å¯ä»£'
            when f.db = 'UFDATA_889_2018' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_889_2019' then 'ç¾åšç‰¹'
            when f.db = 'UFDATA_555_2018' then 'è´å®‰äº‘'
            when f.db = 'UFDATA_007_2019' then 'ç”„å…ƒ'
            end as cohr
      ,f.dbill_date
      ,a.fashengrq
      ,a.bx_name
      ,a.bi_cuscode
      ,a.bi_cusname
      ,a.kehumc
      ,a.province
      ,case when b.liuchengbh is not null then b.cdepname     else f.cdepname      end
      ,case when b.liuchengbh is not null then c.cdept_id_ehr else d.cdept_id_ehr  end
      ,case when b.liuchengbh is not null then c.name_ehr     else d.name_ehr      end
      ,case when b.liuchengbh is not null then c.second_dept  else d.second_dept   end
      ,case when b.liuchengbh is not null then c.third_dept   else d.third_dept    end
      ,case when b.liuchengbh is not null then c.fourth_dept  else d.fourth_dept   end
      ,case when b.liuchengbh is not null then c.fifth_dept   else d.fifth_dept    end
      ,case when b.liuchengbh is not null then c.sixth_dept   else d.sixth_dept    end
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,f.voucher_id
      ,a.neibuhylxmc as fylx
      ,a.u8dykm
      ,a.oadykm
      ,a.oa_ccode
      ,a.oa_ccode_name
      ,a.oa_ccode_lv2
      ,a.oa_ccode_name_lv2
      ,a.jine
      ,a.liuchengbh
      ,a.beizhu
      ,case when f.liuchengbh is null then 'æœªçŸ¥æƒ…å†µ' else 'å…±æœ‰' end
      ,case when b.liuchengbh is not null then b.cdept_id     else f.cdept_id      end
      ,'å–'
  from pdm.accvouch_oa_pre a
  left join (select * from pdm.accvouch_u8_pre group by liuchengbh,md) b
    on a.liuchengbh = b.liuchengbh
   and a.jine = b.md
  left join (select * from edw.dic_deptment group by cdept_id,db) c
    on b.cdept_id = c.cdept_id
   and left(b.db,10) = left(c.db,10)
  left join (select * from pdm.accvouch_u8_pre1 group by liuchengbh) f
    on a.liuchengbh = f.liuchengbh
  left join (select * from edw.dic_deptment group by cdept_id,db) d
    on f.cdept_id = d.cdept_id
   and left(f.db,10) = left(d.db,10)

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002159
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002159

create temporary table pdm.account_fy_mon_del as
select distinct liuchengbh
      ,dbill_date
  from pdm.account_fy_mon
 where state2 = '2'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002159
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002159

create temporary table pdm.account_fy_mon_del1 as select * from pdm.account_fy_mon_del
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002159
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002159

delete a,b 
  from pdm.account_fy  as a 
  join pdm.account_fy_mon_del as b 
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh 

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002159
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002159

insert into pdm.account_fy
select a.i_id
      ,a.db
      ,a.cohr
      ,a.dbill_date
      ,a.fashengrq
      ,a.cpersonname
      ,a.ccuscode
      ,a.ccusname
      ,a.kehumc
      ,a.province
      ,a.name_u8
      ,a.name_ehr_id
      ,a.name_ehr
      ,a.second_dept
      ,a.third_dept
      ,a.fourth_dept
      ,a.fifth_dept
      ,a.sixth_dept
      ,a.bx_name
      ,a.bxr_dept_name
      ,a.cd_name
      ,a.voucher_id
      ,a.fylx
      ,null
      ,a.kemu
      ,a.code
      ,a.code_name
      ,a.code_lv2
      ,a.code_name_lv2
      ,a.md
      ,a.liuchengbh
      ,a.beizhu
      ,a.state
      ,a.cdept_id
      ,a.status
  from pdm.account_fy_mon a
  left join pdm.account_fy_mon_del1 b
    on a.dbill_date = b.dbill_date
   and a.liuchengbh = b.liuchengbh
 where b.dbill_date is not null

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002159
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002159




update pdm.account_fy
   set status = 'ä¸å–'
 where code = '660279'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002200
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002200

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6603'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002200
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002200

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6604'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002200
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002200

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '640106'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002200
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002200

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,4) = '6403'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002200
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002200
 
update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '510118'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002200
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002200

update pdm.account_fy
   set status = 'ä¸å–'
 where cohr = 'åšåœ£å¥åº·'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002201

update pdm.account_fy
   set status = 'ä¸å–'
 where left(code,6) = '530135'
   and md = '1415094.35'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002201


update pdm.account_fy
   set fashengrq = null
 where fashengrq = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002201
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002201

update pdm.account_fy
   set ccuscode = null
 where ccuscode = ''
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002202

update pdm.account_fy a
 inner join (select * from ufdata.department where db = 'UFDATA_111_2018' group by cdepcode) b
    on a.cdept_id = b.cdepcode
   set a.name_u8 = cdepname
 where a.db = 'UFDATA_118_2018'
    or a.db = 'UFDATA_123_2018'

;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002202

update pdm.account_fy set kemu = '6602ä¸“ä¸šæœºæ„è´¹',code='66020015',code_name='ä¸“ä¸šæœºæ„è´¹',code_lv2='66020015',code_name_lv2 ='ä¸“ä¸šæœºæ„è´¹' where cohr = 'ç”„å…ƒ' and kemu = '6601ææ–™'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002202
update pdm.account_fy set kemu = '6601ä¼šåŠ¡è´¹',code='660128',code_name='ä¼šåŠ¡è´¹',code_lv2='660128',code_name_lv2 ='ä¼šåŠ¡è´¹' where cohr = 'å¥¥åšç‰¹' and kemu = '6601ä¼šåŠ¡æ‹›å¾…'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002202
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002202
update pdm.account_fy set kemu = '6601ä¼šåŠ¡è´¹',code='660128',code_name='ä¼šåŠ¡è´¹',code_lv2='660128',code_name_lv2 ='ä¼šåŠ¡è´¹' where cohr = 'ç¾åšç‰¹' and kemu = '6601ä¼šåŠ¡æ‹›å¾…'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002203
update pdm.account_fy set kemu = '6601ä¼šåŠ¡è´¹',code='660128',code_name='ä¼šåŠ¡è´¹',code_lv2='660128',code_name_lv2 ='ä¼šåŠ¡è´¹' where cohr = 'åšåœ£' and kemu = '6601ä¼šåŠ¡æ‹›å¾…'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002203
update pdm.account_fy set kemu = '6601ä¼šåŠ¡è´¹',code='660128',code_name='ä¼šåŠ¡è´¹',code_lv2='660128',code_name_lv2 ='ä¼šåŠ¡è´¹' where cohr = 'åšåœ£' and kemu = '6602ä¼šåŠ¡æ‹›å¾…'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002203
update pdm.account_fy set kemu = '6601äººå‘˜æˆæœ¬',code='6601010104',code_name='äº¤é€šè¡¥è´´',code_lv2='660101',code_name_lv2 ='äººå‘˜æˆæœ¬' where cohr = 'åšåœ£' and kemu = '6601äº¤é€šè¡¥è´´'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002203
update pdm.account_fy set kemu = '6601äººå‘˜æˆæœ¬',code='6601010104',code_name='äº¤é€šè¡¥è´´',code_lv2='660101',code_name_lv2 ='äººå‘˜æˆæœ¬' where cohr = 'ç¾åšç‰¹' and kemu = '6601äº¤é€šè¡¥è´´'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002203
update pdm.account_fy set kemu = '6602å†…éƒ¨ä¼šè®®è´¹',code='660204',code_name='å†…éƒ¨ä¼šè®®è´¹',code_lv2='660204',code_name_lv2 ='å†…éƒ¨ä¼šè®®è´¹' where cohr = 'ç”„å…ƒ' and kemu = '6602å†…éƒ¨ä¼šè®®è´¹'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002203
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002203
update pdm.account_fy set kemu = '6602ä¸“ä¸šæœºæ„è´¹',code='66020015',code_name='ä¸“ä¸šæœºæ„è´¹',code_lv2='66020015',code_name_lv2 ='ä¸“ä¸šæœºæ„è´¹' where cohr = 'ç”„å…ƒ' and kemu = '6602å¤–éƒ¨æœåŠ¡è´¹'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002204
update pdm.account_fy set kemu = '6403å°èŠ±ç¨',code='640305',code_name='å°èŠ±ç¨',code_lv2='640305',code_name_lv2 ='å°èŠ±ç¨' where cohr = 'æ©å…' and kemu = '6602å°èŠ±ç¨'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002204
update pdm.account_fy set kemu = '6403å°èŠ±ç¨',code='640305',code_name='å°èŠ±ç¨',code_lv2='640305',code_name_lv2 ='å°èŠ±ç¨' where cohr = 'å¥¥åšç‰¹' and kemu = '6602å°èŠ±ç¨'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002204
update pdm.account_fy set kemu = '6403å°èŠ±ç¨',code='640305',code_name='å°èŠ±ç¨',code_lv2='640305',code_name_lv2 ='å°èŠ±ç¨' where cohr = 'è´å®‰äº‘' and kemu = '6602å°èŠ±ç¨'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002204
update pdm.account_fy set kemu = '6601ä¼šåŠ¡è´¹',code='660128',code_name='ä¼šåŠ¡è´¹',code_lv2='660128',code_name_lv2 ='ä¼šåŠ¡è´¹' where cohr = 'ç¾åšç‰¹' and kemu = '6601é™¢å†…æ²™é¾™'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002204
SQLå¼€å§‹æ‰§è¡Œæ—¶é—´ï¼š20190929002204
update pdm.account_fy set kemu = '6601è€—æåŠé…ä»¶',code='660118',code_name='è€—æåŠé…ä»¶',code_lv2='660118',code_name_lv2 ='è€—æåŠé…ä»¶' where cohr = 'ç”„å…ƒ' and kemu = '6601è¿è¥è´¹ç”¨'
;
SQLç»“æŸæ‰§è¡Œæ—¶é—´ï¼š20190929002204
